# 秘信小程序云开发部署指南

## 修复"微信一键登录"问题

如果你遇到了"登录失败，请重试"的问题，可以按照以下步骤进行修复：

## 1. 确保云开发环境已开通

首先，确保你已经在微信开发者工具中开通了云开发环境：

1. 打开微信开发者工具，加载秘信小程序项目
2. 点击菜单栏中的"云开发"按钮
3. 如果尚未开通，请按照提示创建一个新的云环境
4. 创建环境时选择"付费环境"或"免费环境"均可

## 2. 修改云环境ID

创建云环境后，需要将代码中的云环境ID修改为你自己的：

1. 在微信开发者工具的云开发控制台中，复制你的云环境ID
2. 修改以下文件中的云环境ID：
   - `app.js` 中的 `initCloud` 函数
   - 所有云函数中的 `cloud.init` 调用（位于每个云函数的 `index.js` 文件中）

## 3. 创建必要的数据库集合

在云开发控制台中创建以下数据库集合：

- `users`：存储用户信息
- `messages`：存储消息内容
- `conversations`：存储会话列表

每个集合创建后，修改其权限设置为"所有用户可读写"（仅用于测试，生产环境应该设置更严格的权限）。

## 4. 部署所有云函数

部署云函数有两种方式：

### 方式一：使用微信开发者工具一键部署

1. 在微信开发者工具中，依次点击菜单："云开发" -> "云函数列表"
2. 点击"一键部署"按钮
3. 等待所有云函数部署完成

### 方式二：单独部署每个云函数

1. 在项目文件树中，右键点击 `cloudfunctions` 目录中的每个云函数文件夹
2. 在弹出菜单中选择"上传并部署"
3. 在弹出的对话框中，选择"云端安装依赖"（这一步很重要！）
4. 点击"确定"开始部署
5. 对每个云函数（login、getConversations、getMessages、sendMessage、destroyMessage）重复上述步骤

## 5. 检查云函数日志

如果部署后仍然无法登录，可以查看云函数日志来定位问题：

1. 打开微信开发者工具的云开发控制台
2. 点击左侧菜单的"云函数"
3. 在右侧选择"login"云函数
4. 点击"日志"选项卡
5. 尝试在小程序中登录，然后刷新日志页面
6. 查看日志中的错误信息

## 常见问题及解决方案

### 1. "找不到云函数"错误

- **问题**：登录时提示"登录功能未部署，请联系管理员"
- **解决方案**：确保已正确部署login云函数，并选择了"云端安装依赖"选项

### 2. 数据库权限错误

- **问题**：登录时提示"数据库操作失败"
- **解决方案**：在云开发控制台中检查数据库集合权限，确保用户可以读写

### 3. 云环境ID错误

- **问题**：提示"初始化云环境失败"
- **解决方案**：确保app.js和云函数中的环境ID与你实际创建的云环境ID一致

### 4. 小程序未授权云开发能力

- **问题**：无法调用云函数
- **解决方案**：在微信公众平台的小程序后台，检查"开发">"开发设置">"服务器域名"中是否添加了云开发域名

## 联系支持

如果你仍然遇到问题，请联系我们的支持团队：
- 邮箱：contact@example.com 