# ğŸš€ äº‘å‡½æ•°æ‰‹åŠ¨åˆ›å»ºå®Œæ•´æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

éœ€è¦åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºä»¥ä¸‹3ä¸ªäº‘å‡½æ•°ï¼š
- `createChat` - åˆ›å»ºèŠå¤©ä¼šè¯
- `sendMessage` - å‘é€æ¶ˆæ¯  
- `getMessages` - è·å–æ¶ˆæ¯åˆ—è¡¨

æ¯ä¸ªå‡½æ•°éƒ½éœ€è¦2ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼š
1. **index.js** - ä¸»è¦ä¸šåŠ¡é€»è¾‘ä»£ç 
2. **package.json** - ä¾èµ–é…ç½®æ–‡ä»¶

---

## ğŸ”¥ ç¬¬ä¸€ä¸ªå‡½æ•°ï¼šcreateChat

### æ­¥éª¤1ï¼šåœ¨äº‘å¼€å‘æ§åˆ¶å°åˆ›å»ºå‡½æ•°
1. æ‰“å¼€ï¼šhttps://console.cloud.tencent.com/tcb/scf
2. é€‰æ‹©ç¯å¢ƒï¼š`ququer-env-6g35f0nv28c446e7`
3. ç‚¹å‡» "æ–°å»º" æŒ‰é’®
4. å‡½æ•°åç§°ï¼š`createChat`
5. è¿è¡Œç¯å¢ƒï¼š`Node.js 16.13`
6. åˆ›å»ºæ–¹å¼ï¼š`ç©ºç™½å‡½æ•°`
7. ç‚¹å‡» "ä¸‹ä¸€æ­¥"

### æ­¥éª¤2ï¼šåˆ›å»ºindex.jsæ–‡ä»¶
åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­ï¼Œåˆ é™¤é»˜è®¤ä»£ç ï¼Œç²˜è´´ä»¥ä¸‹å®Œæ•´ä»£ç ï¼š

```javascript
/**
 * åˆ›å»ºèŠå¤©äº‘å‡½æ•°
 * æ”¯æŒä¸¤ç§åˆ›å»ºæ–¹å¼ï¼š
 * 1. é€šè¿‡targetUserIdåˆ›å»ºï¼ˆæ”¯æŒè€ç‰ˆæœ¬æ¥å£ï¼‰
 * 2. é€šè¿‡chatIdç›´æ¥åˆ›å»ºï¼ˆæ”¯æŒæ–°ç‰ˆæœ¬æ¥å£ï¼‰
 */
const cloud = require('wx-server-sdk');

// åˆå§‹åŒ–äº‘ç¯å¢ƒ
cloud.init({
  env: 'ququer-env-6g35f0nv28c446e7',
  // æ·»åŠ å®‰å…¨ç›¸å…³é…ç½®
  securityHeaders: {
    enableCrossOriginIsolation: true,
    crossOriginOpenerPolicy: {
      value: 'same-origin'
    },
    crossOriginEmbedderPolicy: {
      value: 'require-corp'
    },
    crossOriginResourcePolicy: {
      value: 'same-origin'
    }
  }
});

// è·å–æ•°æ®åº“å¼•ç”¨
const db = cloud.database();
const _ = db.command;

/**
 * åˆ›å»ºèŠå¤©äº‘å‡½æ•°å…¥å£
 * @param {Object} event - äº‘å‡½æ•°è°ƒç”¨å‚æ•°
 * @param {Object} context - äº‘å‡½æ•°è°ƒç”¨ä¸Šä¸‹æ–‡
 * @returns {Promise} è¿”å›å¤„ç†ç»“æœ
 */
exports.main = async (event, context) => {
  console.log('[äº‘å‡½æ•°] createChat è¢«è°ƒç”¨ï¼Œå‚æ•°:', event);
  
  const wxContext = cloud.getWXContext();
  const userId = wxContext.OPENID;
  
  if (!userId) {
    return {
      success: false,
      error: 'è·å–ç”¨æˆ·IDå¤±è´¥'
    };
  }
  
  try {
    let chatId;
    let participantIds = [];
    
    // ç¡®å®šèŠå¤©IDå’Œå‚ä¸è€…
    if (event.chatId) {
      // æ–¹å¼1: ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„chatId
      chatId = event.chatId;
      
      // ä»æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨è¯¥èŠå¤©
      const existingChat = await db.collection('conversations').doc(chatId).get()
        .catch(() => ({ data: null }));
      
      if (existingChat.data) {
        // èŠå¤©å·²å­˜åœ¨ï¼Œä»…æ›´æ–°å½“å‰ç”¨æˆ·çš„çŠ¶æ€
        const participants = existingChat.data.participants || [];
        
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²åœ¨å‚ä¸è€…åˆ—è¡¨ä¸­
        if (!participants.includes(userId)) {
          participants.push(userId);
          await db.collection('conversations').doc(chatId).update({
            data: {
              participants: participants,
              updatedAt: db.serverDate()
            }
          });
        }
        
        return {
          success: true,
          chatId: chatId,
          exists: true,
          message: 'æˆåŠŸåŠ å…¥å·²å­˜åœ¨çš„èŠå¤©'
        };
      }
      
      // å¦‚æœèŠå¤©ä¸å­˜åœ¨ï¼Œä½¿ç”¨chatIdåˆ›å»º
      participantIds = [userId];
    } else if (event.targetUserId) {
      // æ–¹å¼2: é€šè¿‡ç›®æ ‡ç”¨æˆ·IDåˆ›å»º
      const targetUserId = event.targetUserId;
      
      if (!targetUserId || targetUserId === userId) {
        return {
          success: false,
          error: 'æ— æ•ˆçš„ç›®æ ‡ç”¨æˆ·ID'
        };
      }
      
      // æŒ‰ç…§IDé¡ºåºç”ŸæˆèŠå¤©ID
      participantIds = [userId, targetUserId].sort();
      chatId = participantIds.join('_');
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨èŠå¤©
      const existingChat = await db.collection('conversations').where({
        _id: chatId
      }).get();
      
      if (existingChat.data && existingChat.data.length > 0) {
        return {
          success: true,
          chatId: chatId,
          exists: true,
          message: 'èŠå¤©å·²å­˜åœ¨'
        };
      }
    } else {
      return {
        success: false,
        error: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼šchatIdæˆ–targetUserId'
      };
    }
    
    // åˆ›å»ºæ–°èŠå¤©è®°å½•
    const timestamp = db.serverDate();
    
    // é¦–æ¬¡åˆ›å»ºèŠå¤©è®°å½•
    await db.collection('conversations').add({
      data: {
        _id: chatId,
        participants: participantIds,
        createdBy: userId,
        createdAt: timestamp,
        updatedAt: timestamp,
        lastMessage: event.message || 'åˆ›å»ºäº†èŠå¤©',
        lastMessageTime: timestamp,
        status: 'active'
      }
    });
    
    // å¦‚æœæœ‰åˆå§‹æ¶ˆæ¯ï¼Œä¿å­˜åˆ°æ¶ˆæ¯é›†åˆ
    if (event.message) {
      const messageId = `msg_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
      await db.collection('messages').add({
        data: {
          _id: messageId,
          chatId: chatId,
          senderId: userId,
          content: event.message,
          type: 'system',
          sendTime: timestamp,
          status: 'sent',
          destroyed: false
        }
      });
    }
    
    return {
      success: true,
      chatId: chatId,
      exists: false,
      message: 'æˆåŠŸåˆ›å»ºèŠå¤©'
    };
  } catch (error) {
    console.error('[äº‘å‡½æ•°] createChat æ‰§è¡Œå‡ºé”™:', error);
    
    return {
      success: false,
      error: error.message || 'åˆ›å»ºèŠå¤©å¤±è´¥'
    };
  }
};
```

### æ­¥éª¤3ï¼šåˆ›å»ºpackage.jsonæ–‡ä»¶
1. åœ¨äº‘å¼€å‘æ§åˆ¶å°ï¼Œç‚¹å‡» "æ–°å»ºæ–‡ä»¶"
2. æ–‡ä»¶åï¼š`package.json`
3. ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "name": "createChat",
  "version": "1.0.0",
  "description": "åˆ›å»ºèŠå¤©ä¼šè¯äº‘å‡½æ•°",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "wx-server-sdk": "latest"
  }
}
```

### æ­¥éª¤4ï¼šéƒ¨ç½²å‡½æ•°
ç‚¹å‡» "éƒ¨ç½²" æŒ‰é’®ï¼Œç­‰å¾…éƒ¨ç½²å®Œæˆã€‚

---

## ğŸ”¥ ç¬¬äºŒä¸ªå‡½æ•°ï¼šsendMessage

### æ­¥éª¤1ï¼šåˆ›å»ºå‡½æ•°
1. å›åˆ°äº‘å‡½æ•°åˆ—è¡¨
2. ç‚¹å‡» "æ–°å»º" æŒ‰é’®  
3. å‡½æ•°åç§°ï¼š`sendMessage`
4. è¿è¡Œç¯å¢ƒï¼š`Node.js 16.13`
5. åˆ›å»ºæ–¹å¼ï¼š`ç©ºç™½å‡½æ•°`

### æ­¥éª¤2ï¼šåˆ›å»ºindex.jsæ–‡ä»¶
ç²˜è´´ä»¥ä¸‹å®Œæ•´ä»£ç ï¼š

```javascript
/**
 * å‘é€æ¶ˆæ¯äº‘å‡½æ•°
 * ç”¨äºå¤„ç†æ¶ˆæ¯å‘é€ã€åŠ å¯†ç­‰æ“ä½œ
 */
const cloud = require('wx-server-sdk');
const crypto = require('crypto');

// åˆå§‹åŒ–äº‘å¼€å‘ç¯å¢ƒ
cloud.init({
  env: 'ququer-env-6g35f0nv28c446e7'
});

/**
 * AESåŠ å¯†æ¶ˆæ¯å†…å®¹
 * @param {String} content - æ¶ˆæ¯å†…å®¹
 * @param {String} key - åŠ å¯†å¯†é’¥
 * @returns {String} åŠ å¯†åçš„å†…å®¹
 */
function encryptMessage(content, key) {
  // å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨å®‰å…¨çš„å¯†é’¥ç®¡ç†ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv('aes-256-cbc', Buffer.from(key), iv);
  let encrypted = cipher.update(content, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return iv.toString('hex') + ':' + encrypted;
}

/**
 * å‘é€æ¶ˆæ¯äº‘å‡½æ•°å…¥å£
 * @param {Object} event - äº‘å‡½æ•°è°ƒç”¨å‚æ•°
 * @param {Object} context - äº‘å‡½æ•°è°ƒç”¨ä¸Šä¸‹æ–‡
 * @returns {Promise<Object>} è¿”å›æ¶ˆæ¯å‘é€ç»“æœ
 */
exports.main = async (event, context) => {
  console.log('å‘é€æ¶ˆæ¯äº‘å‡½æ•°è¢«è°ƒç”¨', event);
  
  // ğŸ”¥ ä¿®æ”¹å‚æ•°éªŒè¯ï¼šç°åœ¨ä½¿ç”¨chatIdè€Œä¸æ˜¯receiverId
  if (!event.chatId || !event.content || !event.type) {
    return {
      success: false,
      error: 'å‚æ•°ä¸å®Œæ•´ï¼Œéœ€è¦chatIdã€contentå’Œtype'
    };
  }
  
  const wxContext = cloud.getWXContext();
  const senderId = wxContext.OPENID;
  
  // åˆå§‹åŒ–æ•°æ®åº“
  const db = cloud.database();
  const messagesCollection = db.collection('messages');
  const conversationsCollection = db.collection('conversations');
  
  try {
    // ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID
    const messageId = `msg_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
    
    // åŠ å¯†æ¶ˆæ¯å†…å®¹ (ä½¿ç”¨å›ºå®šå¯†é’¥ï¼Œå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å®‰å…¨çš„å¯†é’¥ç®¡ç†)
    const encryptionKey = '0123456789abcdef0123456789abcdef'; // 32ä½å¯†é’¥
    const encryptedContent = encryptMessage(event.content, encryptionKey);
    
    // ğŸ”¥ åˆ›å»ºæ¶ˆæ¯è®°å½• - ä½¿ç”¨chatIdå­—æ®µ
    const messageData = {
      _id: messageId,
      chatId: event.chatId, // ğŸ”¥ æ·»åŠ chatIdå­—æ®µ
      senderId: senderId,
      // ğŸ”¥ ä¿ç•™receiverIdç”¨äºå…¼å®¹ï¼Œä½†ç°åœ¨ä¸»è¦ä½¿ç”¨chatId
      receiverId: event.receiverId || 'group', 
      type: event.type, // 'text', 'image', 'voice', 'video', 'system'
      content: encryptedContent,
      originalContent: event.type !== 'text' ? event.fileId : '', // å¦‚æœæ˜¯åª’ä½“æ¶ˆæ¯ï¼Œä¿å­˜æ–‡ä»¶ID
      sendTime: db.serverDate(),
      status: 'sent', // 'sent', 'received', 'read', 'destroyed'
      destroyed: false,
      // é”€æ¯ç›¸å…³
      viewTime: null,
      destroyTime: null,
      destroyTimeout: event.destroyTimeout || 10 // é»˜è®¤10ç§’åé”€æ¯
    };
    
    // ä¿å­˜æ¶ˆæ¯
    await messagesCollection.add({
      data: messageData
    });
    
    // ğŸ”¥ æ›´æ–°ä¼šè¯çš„æœ€æ–°æ¶ˆæ¯ä¿¡æ¯
    const lastMessagePreview = event.type === 'text' ? 
      event.content.substring(0, 20) : 
      `[${event.type === 'image' ? 'å›¾ç‰‡' : (event.type === 'voice' ? 'è¯­éŸ³' : (event.type === 'video' ? 'è§†é¢‘' : 'æ¶ˆæ¯'))}]`;
    
    // å°è¯•æ›´æ–°ä¼šè¯
    try {
      await conversationsCollection.doc(event.chatId).update({
        data: {
          lastMessage: lastMessagePreview,
          lastMessageTime: db.serverDate(),
          lastMessageSender: senderId,
          updateTime: db.serverDate()
        }
      });
      console.log('ä¼šè¯æœ€æ–°æ¶ˆæ¯å·²æ›´æ–°');
    } catch (updateErr) {
      console.log('æ›´æ–°ä¼šè¯å¤±è´¥ï¼ˆä¼šè¯å¯èƒ½ä¸å­˜åœ¨ï¼‰:', updateErr.message);
      // ä¸å½±å“æ¶ˆæ¯å‘é€ï¼Œç»§ç»­æ‰§è¡Œ
    }
    
    return {
      success: true,
      messageId: messageId,
      chatId: event.chatId
    };
  } catch (err) {
    console.error('å‘é€æ¶ˆæ¯å‡ºé”™', err);
    return {
      success: false,
      error: err.message || 'å‘é€æ¶ˆæ¯å¤±è´¥'
    };
  }
};
```

### æ­¥éª¤3ï¼šåˆ›å»ºpackage.jsonæ–‡ä»¶
1. ç‚¹å‡» "æ–°å»ºæ–‡ä»¶"
2. æ–‡ä»¶åï¼š`package.json`
3. ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "name": "sendMessage",
  "version": "1.0.0",
  "description": "å‘é€æ¶ˆæ¯äº‘å‡½æ•°",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

### æ­¥éª¤4ï¼šéƒ¨ç½²å‡½æ•°
ç‚¹å‡» "éƒ¨ç½²" æŒ‰é’®ã€‚

---

## ğŸ”¥ ç¬¬ä¸‰ä¸ªå‡½æ•°ï¼šgetMessages

### æ­¥éª¤1ï¼šåˆ›å»ºå‡½æ•°
1. å›åˆ°äº‘å‡½æ•°åˆ—è¡¨
2. ç‚¹å‡» "æ–°å»º" æŒ‰é’®
3. å‡½æ•°åç§°ï¼š`getMessages`
4. è¿è¡Œç¯å¢ƒï¼š`Node.js 16.13`
5. åˆ›å»ºæ–¹å¼ï¼š`ç©ºç™½å‡½æ•°`

### æ­¥éª¤2ï¼šåˆ›å»ºindex.jsæ–‡ä»¶
ç²˜è´´ä»¥ä¸‹å®Œæ•´ä»£ç ï¼š

```javascript
/**
 * è·å–æ¶ˆæ¯åˆ—è¡¨äº‘å‡½æ•°
 */
const cloud = require('wx-server-sdk');
const crypto = require('crypto');

// åˆå§‹åŒ–äº‘å¼€å‘ç¯å¢ƒ
cloud.init({
  env: 'ququer-env-6g35f0nv28c446e7'
});

/**
 * è§£å¯†æ¶ˆæ¯å†…å®¹
 * @param {String} encryptedContent - åŠ å¯†çš„æ¶ˆæ¯å†…å®¹
 * @param {String} key - è§£å¯†å¯†é’¥
 * @returns {String} è§£å¯†åçš„å†…å®¹
 */
function decryptMessage(encryptedContent, key) {
  try {
    const parts = encryptedContent.split(':');
    const iv = Buffer.from(parts[0], 'hex');
    const encrypted = parts[1];
    const decipher = crypto.createDecipheriv('aes-256-cbc', Buffer.from(key), iv);
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    return decrypted;
  } catch (err) {
    console.error('è§£å¯†æ¶ˆæ¯å¤±è´¥', err);
    return '[åŠ å¯†æ¶ˆæ¯]';
  }
}

/**
 * è·å–æ¶ˆæ¯åˆ—è¡¨äº‘å‡½æ•°å…¥å£
 * @param {Object} event - äº‘å‡½æ•°è°ƒç”¨å‚æ•°
 * @param {Object} context - äº‘å‡½æ•°è°ƒç”¨ä¸Šä¸‹æ–‡
 * @returns {Promise<Object>} è¿”å›æ¶ˆæ¯åˆ—è¡¨
 */
exports.main = async (event, context) => {
  console.log('è·å–æ¶ˆæ¯äº‘å‡½æ•°è¢«è°ƒç”¨', event);
  
  // ğŸ”¥ ä¿®æ”¹å‚æ•°éªŒè¯ï¼šæ”¯æŒchatIdå‚æ•°
  if (!event.conversationId && !event.targetUserId && !event.chatId) {
    return {
      success: false,
      error: 'å‚æ•°ä¸å®Œæ•´ï¼Œéœ€è¦conversationIdã€targetUserIdæˆ–chatIdå…¶ä¸­ä¹‹ä¸€'
    };
  }
  
  const wxContext = cloud.getWXContext();
  const userId = wxContext.OPENID;
  
  // åˆå§‹åŒ–æ•°æ®åº“
  const db = cloud.database();
  const _ = db.command;
  const messagesCollection = db.collection('messages');
  
  try {
    // ğŸ”¥ æŸ¥è¯¢æ¡ä»¶ï¼šæ”¯æŒå¤šç§æŸ¥è¯¢æ–¹å¼
    let queryCondition;
    
    if (event.chatId) {
      // ğŸ”¥ å¦‚æœæä¾›äº†chatIdï¼Œç›´æ¥æŒ‰chatIdæŸ¥è¯¢
      console.log('æŒ‰chatIdæŸ¥è¯¢æ¶ˆæ¯:', event.chatId);
      queryCondition = {
        chatId: event.chatId
      };
    } else if (event.targetUserId) {
      // å¦‚æœæä¾›äº†ç›®æ ‡ç”¨æˆ·IDï¼ŒæŸ¥è¯¢ä¸è¯¥ç”¨æˆ·çš„å¯¹è¯ï¼ˆå…¼å®¹æ—§æ¨¡å¼ï¼‰
      console.log('æŒ‰targetUserIdæŸ¥è¯¢æ¶ˆæ¯:', event.targetUserId);
      queryCondition = _.or([
        {
          senderId: userId,
          receiverId: event.targetUserId
        },
        {
          senderId: event.targetUserId,
          receiverId: userId
        }
      ]);
    } else if (event.conversationId) {
      // å¦‚æœæä¾›äº†ä¼šè¯IDï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥ä¼šè¯
      console.log('æŒ‰conversationIdæŸ¥è¯¢æ¶ˆæ¯:', event.conversationId);
      const conversationParts = event.conversationId.split('_');
      if (!conversationParts.includes(userId)) {
        return {
          success: false,
          error: 'æ— æƒè®¿é—®è¯¥ä¼šè¯'
        };
      }
      
      // æ„å»ºæŸ¥è¯¢æ¡ä»¶
      queryCondition = _.or([
        {
          senderId: conversationParts[0],
          receiverId: conversationParts[1]
        },
        {
          senderId: conversationParts[1],
          receiverId: conversationParts[0]
        }
      ]);
    }
    
    // ğŸ”¥ æŸ¥è¯¢æ¶ˆæ¯ï¼ˆä¸åŒ…æ‹¬å·²é”€æ¯çš„ï¼‰
    let messagesQuery = messagesCollection
      .where(queryCondition)
      .orderBy('sendTime', 'desc');
    
    // åˆ†é¡µé™åˆ¶
    if (event.limit) {
      messagesQuery = messagesQuery.limit(event.limit);
    } else {
      messagesQuery = messagesQuery.limit(50); // é»˜è®¤è·å–æœ€è¿‘50æ¡
    }
    
    // æ‰§è¡ŒæŸ¥è¯¢
    const messagesResult = await messagesQuery.get();
    console.log(`æŸ¥è¯¢åˆ° ${messagesResult.data.length} æ¡æ¶ˆæ¯`);
    
    // å¯¹æ¶ˆæ¯å†…å®¹è¿›è¡Œè§£å¯†å¤„ç†
    const encryptionKey = '0123456789abcdef0123456789abcdef'; // 32ä½å¯†é’¥
    const messages = messagesResult.data.map(msg => {
      // åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ä»¥é¿å…ä¿®æ”¹åŸå§‹æ•°æ®
      const processedMsg = { ...msg };
      
      // ğŸ”¥ å¦‚æœæ¶ˆæ¯æœªé”€æ¯ä¸”æœ‰åŠ å¯†å†…å®¹ï¼Œåˆ™è§£å¯†
      if (!msg.destroyed && msg.type === 'text' && msg.content) {
        try {
          processedMsg.content = decryptMessage(msg.content, encryptionKey);
        } catch (err) {
          console.error('è§£å¯†æ¶ˆæ¯å¤±è´¥', err);
          processedMsg.content = msg.content; // ğŸ”¥ å¦‚æœè§£å¯†å¤±è´¥ï¼Œè¿”å›åŸå†…å®¹
        }
      } else if (msg.destroyed) {
        // å·²é”€æ¯çš„æ¶ˆæ¯å†…å®¹ç½®ç©º
        processedMsg.content = '';
      } else if (msg.type === 'system') {
        // ğŸ”¥ ç³»ç»Ÿæ¶ˆæ¯ä¸éœ€è¦è§£å¯†
        processedMsg.content = msg.content;
      }
      
      return processedMsg;
    });
    
    // æŒ‰ç…§æ—¶é—´æ­£åºè¿”å›
    messages.reverse();
    
    return {
      success: true,
      messages: messages,
      count: messages.length,
      queryType: event.chatId ? 'chatId' : (event.targetUserId ? 'targetUserId' : 'conversationId')
    };
  } catch (err) {
    console.error('è·å–æ¶ˆæ¯åˆ—è¡¨å‡ºé”™', err);
    return {
      success: false,
      error: err.message || 'è·å–æ¶ˆæ¯å¤±è´¥'
    };
  }
};
```

### æ­¥éª¤3ï¼šåˆ›å»ºpackage.jsonæ–‡ä»¶
1. ç‚¹å‡» "æ–°å»ºæ–‡ä»¶"
2. æ–‡ä»¶åï¼š`package.json`
3. ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "name": "getMessages",
  "version": "1.0.0",
  "description": "è·å–èŠå¤©æ¶ˆæ¯äº‘å‡½æ•°",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

### æ­¥éª¤4ï¼šéƒ¨ç½²å‡½æ•°
ç‚¹å‡» "éƒ¨ç½²" æŒ‰é’®ã€‚

---

## âœ… æœ€ç»ˆéªŒè¯

### æ£€æŸ¥äº‘å‡½æ•°åˆ—è¡¨
éƒ¨ç½²å®Œæˆåï¼Œåœ¨äº‘å¼€å‘æ§åˆ¶å°åº”è¯¥èƒ½çœ‹åˆ°8ä¸ªäº‘å‡½æ•°ï¼š

1. âœ… loginï¼ˆå·²å­˜åœ¨ï¼‰
2. âœ… createInviteï¼ˆå·²å­˜åœ¨ï¼‰
3. âœ… joinByInviteï¼ˆå·²å­˜åœ¨ï¼‰
4. âœ… startConversationï¼ˆå·²å­˜åœ¨ï¼‰
5. âœ… checkChatStatusï¼ˆå·²å­˜åœ¨ï¼‰
6. ğŸ†• **createChat**ï¼ˆæ–°åˆ›å»ºï¼‰
7. ğŸ†• **sendMessage**ï¼ˆæ–°åˆ›å»ºï¼‰
8. ğŸ†• **getMessages**ï¼ˆæ–°åˆ›å»ºï¼‰

### æµ‹è¯•éªŒè¯
1. é‡å¯å°ç¨‹åº
2. å°è¯•å‘é€æ¶ˆæ¯
3. æŸ¥çœ‹è°ƒè¯•æ§åˆ¶å°ï¼Œç¡®è®¤æ²¡æœ‰-501000é”™è¯¯
4. éªŒè¯æ¶ˆæ¯èƒ½æ­£å¸¸å‘é€å’Œæ¥æ”¶

---

## ğŸ¯ é‡è¦æé†’

1. **ç¯å¢ƒID**: ç¡®ä¿æ‰€æœ‰å‡½æ•°ä¸­çš„ç¯å¢ƒIDéƒ½æ˜¯ `ququer-env-6g35f0nv28c446e7`
2. **ä¾èµ–ç‰ˆæœ¬**: package.jsonä¸­çš„wx-server-sdkç‰ˆæœ¬è¦ä¿æŒä¸€è‡´
3. **æ–‡ä»¶åç§°**: å¿…é¡»æ˜¯ `index.js` å’Œ `package.json`ï¼Œä¸èƒ½æœ‰å…¶ä»–åç§°
4. **éƒ¨ç½²é¡ºåº**: å»ºè®®æŒ‰ç…§ createChat â†’ sendMessage â†’ getMessages çš„é¡ºåºåˆ›å»º
5. **ä»£ç å®Œæ•´æ€§**: å¿…é¡»å¤åˆ¶å®Œæ•´çš„ä»£ç ï¼Œä¸èƒ½é—æ¼ä»»ä½•éƒ¨åˆ†

æŒ‰ç…§è¿™ä¸ªæŒ‡å—æ“ä½œï¼Œåº”è¯¥èƒ½æˆåŠŸåˆ›å»ºæ‰€æœ‰å¿…éœ€çš„äº‘å‡½æ•°ï¼ 