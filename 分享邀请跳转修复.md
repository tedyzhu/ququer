# ğŸš€ åˆ†äº«é‚€è¯·è·³è½¬é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

ä»æ—¥å¿—åˆ†æå‘ç°ï¼š
1. **åˆ†äº«é“¾æ¥ç”Ÿæˆæ­£ç¡®**ï¼š`/pages/share/share?chatId=xxx&inviter=xxx&isInvitee=true`
2. **å®é™…è·³è½¬è·¯å¾„é”™è¯¯**ï¼šç”¨æˆ·è¿›å…¥äº† `app/pages/login/login` è€Œä¸æ˜¯åˆ†äº«é¡µé¢
3. **å‚æ•°ä¸¢å¤±**ï¼šquery å‚æ•°ä¸ºç©º

## ğŸ¯ æ ¹æœ¬åŸå› 

**å¾®ä¿¡å°ç¨‹åºåˆ†äº«è·¯å¾„è§£æé—®é¢˜**ï¼š
- åˆ†äº«é“¾æ¥ä¸­çš„è·¯å¾„å¯èƒ½è¢«å¾®ä¿¡é‡å®šå‘
- app.json ä¸­åŒæ—¶å­˜åœ¨å¤šä¸ªç›¸ä¼¼é¡µé¢è·¯å¾„é€ æˆå†²çª
- åˆ†äº«é¡µé¢å¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®æ³¨å†Œ

## ğŸš€ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤åˆ†äº«é“¾æ¥è·¯å¾„ï¼ˆæ¨èï¼‰

**æ­¥éª¤1ï¼šç»Ÿä¸€ä½¿ç”¨ app/ è·¯å¾„å‰ç¼€**

ä¿®æ”¹é¦–é¡µçš„åˆ†äº«é“¾æ¥ç”Ÿæˆé€»è¾‘ï¼š

```javascript
// åœ¨ pages/home/home.js ä¸­
onShareAppMessage: function() {
  // ... ç°æœ‰é€»è¾‘ ...
  
  // ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨ app/ å‰ç¼€çš„è·¯å¾„ï¼Œç¡®ä¿è·¯ç”±æ­£ç¡®
  return {
    title: `${nickName}é‚€è¯·ä½ è¿›è¡Œç§å¯†èŠå¤©`,
    path: `/app/pages/share/share?chatId=${shareCreatedChatId}&inviter=${encodeURIComponent(nickName)}&isInvitee=true`,
    imageUrl: '/assets/images/logo.png'
  };
}
```

**æ­¥éª¤2ï¼šç¡®ä¿ app/pages/share/share.js å­˜åœ¨å¹¶æ­£å¸¸å·¥ä½œ**

æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
- `app/pages/share/share.js`
- `app/pages/share/share.wxml` 
- `app/pages/share/share.wxss`
- `app/pages/share/share.json`

å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»ºè¿™äº›æ–‡ä»¶ã€‚

### æ–¹æ¡ˆ2ï¼šæ·»åŠ ç™»å½•é¡µé¢çš„é‚€è¯·å‚æ•°å¤„ç†

**åœ¨ç™»å½•é¡µé¢æ·»åŠ é‚€è¯·å¤„ç†é€»è¾‘**ï¼š

```javascript
// åœ¨ app/pages/login/login.js ä¸­æ·»åŠ 
onLoad: function(options) {
  console.log('[é‚€è¯·æµç¨‹] ç™»å½•é¡µé¢åŠ è½½ï¼Œå‚æ•°:', options);
  
  // ğŸ”¥ æ–°å¢ï¼šå¤„ç†ä»åˆ†äº«é“¾æ¥ä¼ æ¥çš„é‚€è¯·å‚æ•°
  if (options.chatId && options.inviter) {
    console.log('[é‚€è¯·æµç¨‹] æ£€æµ‹åˆ°é‚€è¯·å‚æ•°ï¼Œä¿å­˜åˆ°æœ¬åœ°');
    
    // ä¿å­˜é‚€è¯·ä¿¡æ¯
    wx.setStorageSync('pendingInvite', {
      chatId: options.chatId,
      inviter: decodeURIComponent(options.inviter),
      isInvitee: options.isInvitee === 'true',
      timestamp: Date.now(),
      source: 'login_page_direct'
    });
  }
  
  // ... ç°æœ‰ç™»å½•é€»è¾‘ ...
}
```

### æ–¹æ¡ˆ3ï¼šåˆ›å»ºä¸“ç”¨çš„é‚€è¯·å¤„ç†é€»è¾‘

**åœ¨ app.js ä¸­æ·»åŠ ç»Ÿä¸€çš„é‚€è¯·å¤„ç†**ï¼š

```javascript
// åœ¨ app.js ä¸­æ·»åŠ æ–¹æ³•
handleInviteParams: function(options) {
  console.log('[é‚€è¯·æµç¨‹] å¤„ç†é‚€è¯·å‚æ•°:', options);
  
  // æå–å¯èƒ½çš„é‚€è¯·å‚æ•°
  const chatId = options.chatId || options.inviteId;
  const inviter = options.inviter;
  const isInvitee = options.isInvitee === 'true';
  
  if (chatId && inviter) {
    console.log('[é‚€è¯·æµç¨‹] å‘ç°é‚€è¯·ä¿¡æ¯ï¼Œä¿å­˜å¹¶å¤„ç†');
    
    // ä¿å­˜é‚€è¯·ä¿¡æ¯
    const inviteInfo = {
      chatId: chatId,
      inviter: decodeURIComponent(inviter),
      isInvitee: isInvitee,
      timestamp: Date.now(),
      source: 'app_level_handler'
    };
    
    wx.setStorageSync('pendingInvite', inviteInfo);
    
    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œç›´æ¥å¤„ç†é‚€è¯·
    if (this.globalData.hasLogin && this.globalData.userInfo) {
      this.processPendingInvite();
    }
    
    return true; // è¡¨ç¤ºæœ‰é‚€è¯·è¢«å¤„ç†
  }
  
  return false; // æ— é‚€è¯·ä¿¡æ¯
},

processPendingInvite: function() {
  const pendingInvite = wx.getStorageSync('pendingInvite');
  
  if (pendingInvite && pendingInvite.chatId) {
    console.log('[é‚€è¯·æµç¨‹] å¤„ç†å¾…å¤„ç†çš„é‚€è¯·:', pendingInvite);
    
    // è°ƒç”¨ joinByInvite äº‘å‡½æ•°
    wx.cloud.callFunction({
      name: 'joinByInvite',
      data: {
        chatId: pendingInvite.chatId,
        joiner: {
          openId: this.globalData.openId,
          nickName: this.globalData.userInfo.nickName,
          avatarUrl: this.globalData.userInfo.avatarUrl
        }
      },
      success: (res) => {
        if (res.result && res.result.success) {
          console.log('[é‚€è¯·æµç¨‹] åŠ å…¥èŠå¤©æˆåŠŸï¼Œè·³è½¬åˆ°èŠå¤©é¡µé¢');
          
          // æ¸…é™¤å¾…å¤„ç†é‚€è¯·
          wx.removeStorageSync('pendingInvite');
          
          // è·³è½¬åˆ°èŠå¤©é¡µé¢
          wx.reLaunch({
            url: `/pages/chat/chat?id=${pendingInvite.chatId}&chatStarted=true&fromInvite=true`
          });
        }
      },
      fail: (err) => {
        console.error('[é‚€è¯·æµç¨‹] å¤„ç†é‚€è¯·å¤±è´¥:', err);
      }
    });
  }
}
```

## ğŸ”§ ç«‹å³ä¿®å¤æ­¥éª¤

### ç¬¬1æ­¥ï¼šä¿®æ”¹åˆ†äº«é“¾æ¥è·¯å¾„

ä¿®æ”¹ `pages/home/home.js` ç¬¬424è¡Œé™„è¿‘çš„åˆ†äº«è·¯å¾„ï¼š

```javascript
// ä¿®æ”¹å‰
path: `/pages/share/share?chatId=${shareCreatedChatId}&inviter=${encodeURIComponent(nickName)}&isInvitee=true`

// ä¿®æ”¹å  
path: `/app/pages/share/share?chatId=${shareCreatedChatId}&inviter=${encodeURIComponent(nickName)}&isInvitee=true`
```

### ç¬¬2æ­¥ï¼šç¡®ä¿åˆ†äº«é¡µé¢æ–‡ä»¶å­˜åœ¨

æ£€æŸ¥å¹¶åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š
- `app/pages/share/share.js` ï¼ˆå¤åˆ¶ `pages/share/share.js` çš„å†…å®¹ï¼‰
- `app/pages/share/share.wxml`ï¼ˆå¤åˆ¶ `pages/share/share.wxml` çš„å†…å®¹ï¼‰
- `app/pages/share/share.wxss`ï¼ˆå¤åˆ¶ `pages/share/share.wxss` çš„å†…å®¹ï¼‰ 
- `app/pages/share/share.json`ï¼ˆå¤åˆ¶ `pages/share/share.json` çš„å†…å®¹ï¼‰

### ç¬¬3æ­¥ï¼šæµ‹è¯•ä¿®å¤ç»“æœ

1. é‡æ–°ç¼–è¯‘å°ç¨‹åº
2. ä½¿ç”¨åˆ†äº«åŠŸèƒ½
3. è§‚å¯Ÿè¢«é‚€è¯·è€…æ˜¯å¦èƒ½æ­£ç¡®è·³è½¬åˆ°åˆ†äº«é¡µé¢
4. éªŒè¯åŒæ–¹æ˜¯å¦èƒ½æˆåŠŸè¿›å…¥èŠå¤©

## ğŸ“Š é¢„æœŸç»“æœ

ä¿®å¤åçš„æµç¨‹ï¼š
1. ç”¨æˆ·ç‚¹å‡»åˆ†äº« â†’ ç”Ÿæˆæ­£ç¡®çš„åˆ†äº«é“¾æ¥
2. è¢«é‚€è¯·è€…ç‚¹å‡»é“¾æ¥ â†’ æ­£ç¡®è¿›å…¥ `app/pages/share/share` é¡µé¢
3. åˆ†äº«é¡µé¢å¤„ç†é‚€è¯· â†’ è°ƒç”¨ `joinByInvite` äº‘å‡½æ•°
4. åŠ å…¥æˆåŠŸ â†’ è‡ªåŠ¨è·³è½¬åˆ°èŠå¤©é¡µé¢
5. åŒæ–¹å¼€å§‹èŠå¤© âœ…

---

**âš¡ å…³é”®æé†’**ï¼š
- ç¡®ä¿è·¯å¾„ä¸€è‡´æ€§ï¼ˆapp/ å‰ç¼€ï¼‰
- éªŒè¯æ‰€æœ‰ç›¸å…³é¡µé¢æ–‡ä»¶å­˜åœ¨
- æµ‹è¯•å®Œæ•´çš„é‚€è¯·æµç¨‹ 