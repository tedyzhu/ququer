<view class="container chat-container">
  <!-- ğŸ”¥ è°ƒè¯•ä¿¡æ¯ -->
  <view class="debug-info" wx:if="{{isDebugMode}}">
    <text>èŠå¤©ID: {{contactId}}</text>
    <text>æ¶ˆæ¯æ•°: {{messages.length}}</text>
    <text>ç”¨æˆ·ID: {{currentUser.openId}}</text>
  </view>
  
  <!-- åˆ›å»ºèŠå¤©çŠ¶æ€è¦†ç›–å±‚ -->
  <view class="creating-chat-overlay" wx:if="{{isCreatingChat}}">
    <view class="creating-chat-content">
      <view class="creating-chat-spinner"></view>
      <text class="creating-chat-text">{{chatCreationStatus || 'æ­£åœ¨åˆ›å»ºèŠå¤©...'}}</text>
    </view>
  </view>
  
  <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
  <scroll-view 
    id="scroll-view"
    scroll-y="true" 
    class="message-list" 
    scroll-top="{{scrollTop}}"
    scroll-with-animation="true"
    enhanced="true"
    show-scrollbar="false">
    
    <view id="message-container" class="messages-container">
      <!-- åŠ è½½ä¸­ -->
      <view wx:if="{{isLoading}}" class="loading-container">
        <view class="loading-spinner"></view>
        <view class="loading-text">åŠ è½½ä¸­...</view>
      </view>
      
      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <block wx:for="{{messages}}" wx:key="id">
        <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
        <view wx:if="{{item.type === 'system'}}" class="message-item system-message">
          <view class="system-message-content">
            <text class="system-message-text">{{item.content}}</text>
            <text class="system-message-time">{{item.time}}</text>
          </view>
        </view>
        
        <!-- å·²é”€æ¯çš„æ¶ˆæ¯ -->
        <view wx:elif="{{item.destroyed}}" class="message-item destroyed-message">
          <view class="message-destroyed-notice">æ¶ˆæ¯å·²é”€æ¯</view>
        </view>
        
        <!-- æœªé”€æ¯çš„æ™®é€šæ¶ˆæ¯ -->
        <view 
          wx:else
          class="message-item {{item.senderId === 'self' ? 'message-self' : 'message-other'}}"
          bindtap="handleMessageTap"
          data-messageid="{{item.id}}">
          
          <!-- æ¶ˆæ¯æ°”æ³¡ -->
          <view class="message-bubble {{item.destroying ? 'destroying' : ''}}">
            <!-- æ¶ˆæ¯å†…å®¹ -->
            <view class="message-content">{{item.content}}</view>
            
            <!-- é”€æ¯å€’è®¡æ—¶ -->
            <view wx:if="{{item.destroying}}" class="destroy-countdown">
              {{item.remainTime}}såé”€æ¯
            </view>
            
            <!-- æ¶ˆæ¯æ—¶é—´å’ŒçŠ¶æ€ -->
            <view class="message-meta">
              <text class="message-time">{{item.time}}</text>
              <text wx:if="{{item.senderId === 'self' && item.status !== 'received'}}" class="message-status">
                {{item.status === 'sending' ? 'å‘é€ä¸­' : 'å·²å‘é€'}}
              </text>
            </view>
          </view>
        </view>
      </block>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <view class="input-box">
      <input 
        class="text-input" 
        value="{{inputValue}}"
        bindinput="handleInputChange"
        confirm-type="send"
        bindconfirm="sendMessage"
        placeholder="è¾“å…¥æ¶ˆæ¯..."
        disabled="{{isCreatingChat}}" />
      
      <view class="toolbar">
        <view class="tool-button emotions-button">
          <image class="tool-icon" src="/assets/images/emoji.png" mode="aspectFit"></image>
        </view>
        
        <view class="tool-button photo-button">
          <image class="tool-icon" src="/assets/images/photo.png" mode="aspectFit"></image>
        </view>
      </view>
    </view>
    
    <button 
      class="send-button {{inputValue ? 'active' : ''}}" 
      bindtap="sendMessage"
      disabled="{{!inputValue || isCreatingChat}}">
      å‘é€
    </button>
  </view>
</view> 