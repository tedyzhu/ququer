<view class="chat-container">
  <!-- è‡ªå®šä¹‰æ ‡é¢˜æ  -->
  <view class="custom-navbar">
    <view class="navbar-left" bindtap="showChatMenu">
      <text class="menu-icon">â‹¯</text>
    </view>
    <view class="navbar-center">
      <view class="chat-title">{{dynamicTitle || 'æ ‡é¢˜åŠ è½½ä¸­...'}}</view>
      <!-- è°ƒè¯•ä¿¡æ¯ -->
      <view wx:if="{{isDebugMode}}" style="font-size: 24rpx; color: #999;">
        DEBUG: {{dynamicTitle ? 'HAS_TITLE' : 'NO_TITLE'}}
      </view>
    </view>
    <view class="navbar-right">
      <!-- å³ä¾§ç•™ç©ºï¼Œé¿å…ä¸å°ç¨‹åºå…³é—­æŒ‰é’®å†²çª -->
    </view>
  </view>

  <!-- é”€æ¯è®¡æ—¶å™¨ -->
  <view class="destroy-timer" wx:if="{{showDestroyTimer}}">
    <view class="timer-text">{{destroyTimerText}}</view>
  </view>
  
  <!-- åˆ›å»ºèŠå¤©çŠ¶æ€ -->
  <view class="creating-chat-overlay" wx:if="{{isCreatingChat}}">
    <view class="creating-chat-content">
      <view class="creating-chat-spinner"></view>
      <text class="creating-chat-text">{{chatCreationStatus || 'æ­£åœ¨åˆ›å»ºèŠå¤©...'}}</text>
    </view>
  </view>
  
  <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
  <scroll-view
    class="messages-container"
    scroll-y="true"
    scroll-into-view="{{scrollIntoView}}"
    enable-flex="true"
  >
    <!-- æ­£åœ¨åŠ è½½ -->
    <view wx:if="{{isLoading}}" class="loading-container">
      <view class="loading"></view>
      <text>åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view wx:else class="messages-list">
      <block wx:for="{{messages}}" wx:key="id">
        <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
        <view 
          wx:if="{{item.isSystem}}"
          id="sys-{{index}}"
          class="message-wrapper system"
        >
          <view class="system-message">
            <text class="message-text">{{item.content}}</text>
          </view>
        </view>
        
        <!-- æ™®é€šæ¶ˆæ¯ - å¾®ä¿¡åŸç”Ÿæ ·å¼ -->
        <view 
          wx:else
          id="msg-{{index}}"
          class="message-item {{item.isSelf ? 'message-self' : 'message-other'}}"
          bindtap="onMessageTap"
          bindlongpress="onMessageLongTap"
          data-msgid="{{item.id}}"
        >
          <!-- æ—¶é—´æ˜¾ç¤º -->
          <view wx:if="{{item.showTime}}" class="message-time-divider">
            <text class="time-text">{{item.timeDisplay}}</text>
          </view>
          
          <view class="message-row">
            <!-- å¯¹æ–¹æ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ä¾§ -->
            <view wx:if="{{!item.isSelf}}" class="message-avatar">
              <image class="avatar-img" src="{{item.avatar}}" mode="aspectFill"></image>
            </view>
            
            <!-- æ¶ˆæ¯æ°”æ³¡ -->
            <view class="message-bubble-wrapper {{item.isSelf ? 'self-bubble' : 'other-bubble'}}">
              <view class="message-bubble {{item.isDestroying ? 'destroying' : ''}} {{item.isDestroyed ? 'destroyed' : ''}}">
                <!-- ğŸ”¥ æ¶ˆæ¯å†…å®¹ï¼šå·²é”€æ¯çš„æ¶ˆæ¯æ˜¾ç¤ºç‰¹æ®Šæ ·å¼ -->
                <view class="bubble-content" wx:if="{{!item.isDestroyed}}">{{item.content}}</view>
                <view class="bubble-content destroyed-content" wx:else>
                  <text class="destroyed-text">ğŸ”¥ æ¶ˆæ¯å·²é”€æ¯</text>
                </view>
                
                <!-- ğŸ”¥ é”€æ¯å€’è®¡æ—¶æç¤º -->
                <view wx:if="{{item.isDestroying && item.remainTime}}" class="destroy-countdown">
                  <text class="countdown-text">ğŸ”¥ {{item.remainTime}}såè‡ªåŠ¨é”€æ¯</text>
                </view>
                
                <!-- ğŸ”¥ ç‚¹å‡»æŸ¥çœ‹æç¤ºï¼ˆé’ˆå¯¹å¯¹æ–¹æ¶ˆæ¯ï¼‰ -->
                <view wx:if="{{!item.isSelf && !item.isDestroyed && !item.isDestroying}}" class="tap-to-read">
                  <text class="tap-hint">ç‚¹å‡»æŸ¥çœ‹ï¼ˆé˜…åå³ç„šï¼‰</text>
                </view>
              </view>
            </view>
            
            <!-- è‡ªå·±æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ä¾§ -->
            <view wx:if="{{item.isSelf}}" class="message-avatar">
              <image class="avatar-img" src="{{item.avatar}}" mode="aspectFill"></image>
            </view>
          </view>
        </view>
      </block>
    </view>
  </scroll-view>
  
  <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
  <view class="input-container">
    <view class="voice-btn" bindtap="toggleVoiceInput">
      <image class="icon" src="/assets/images/mic.png" mode="aspectFit"></image>
    </view>
    
    <input
      class="message-input"
      type="text"
      placeholder="è¾“å…¥æ¶ˆæ¯..."
      value="{{inputValue}}"
      bindinput="onInputChange"
      confirm-type="send"
      bindconfirm="sendMessage"
      disabled="{{isCreatingChat}}"
    />
    
    <view class="emoji-btn" bindtap="openEmojiPicker">
      <image class="icon" src="/assets/images/emoji.png" mode="aspectFit"></image>
    </view>
    
    <view class="more-btn" bindtap="openMoreFunctions">
      <image class="icon" src="/assets/images/more.png" mode="aspectFit"></image>
    </view>
    
    <view class="send-btn" bindtap="sendMessage" wx:if="{{inputValue.length > 0}}">å‘é€</view>
  </view>
</view> 