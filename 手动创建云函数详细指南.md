# ğŸ› ï¸ æ‰‹åŠ¨åˆ›å»ºäº‘å‡½æ•°è¯¦ç»†æŒ‡å—

## é—®é¢˜åŸå› åˆ†æ

å½“äº‘å‡½æ•°ä»£ç å­˜åœ¨ä½†åœ¨äº‘å¼€å‘æ§åˆ¶å°çœ‹ä¸åˆ°æ—¶ï¼Œé€šå¸¸æ˜¯å› ä¸ºï¼š
1. å‡½æ•°ä»£ç å­˜åœ¨ä½†æ²¡æœ‰æ­£ç¡®éƒ¨ç½²åˆ°äº‘ç¯å¢ƒ
2. éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ä½†æ²¡æœ‰æç¤º
3. äº‘å¼€å‘æ§åˆ¶å°ç¼“å­˜é—®é¢˜
4. å‡½æ•°é…ç½®æ–‡ä»¶ç¼ºå¤±æˆ–é”™è¯¯

## ğŸ”¥ æ–¹æ³•1ï¼šå¾®ä¿¡å¼€å‘è€…å·¥å…·å®Œå…¨é‡æ–°éƒ¨ç½²

### ç¬¬ä¸€æ­¥ï¼šæ¸…ç†ç°æœ‰éƒ¨ç½²çŠ¶æ€
1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. ç‚¹å‡»å·¥å…·æ  "äº‘å¼€å‘" æŒ‰é’®
3. åœ¨äº‘å¼€å‘æ§åˆ¶å°ä¸­ï¼Œè¿›å…¥ "äº‘å‡½æ•°" é¡µé¢
4. ç¡®è®¤å½“å‰äº‘å‡½æ•°çŠ¶æ€ï¼ˆè®°å½•å“ªäº›å‡½æ•°æ˜¾ç¤ºä¸º"æ­£å¸¸"ï¼‰

### ç¬¬äºŒæ­¥ï¼šé‡æ–°éƒ¨ç½²ç¼ºå¤±å‡½æ•°
é’ˆå¯¹ä»¥ä¸‹3ä¸ªç¼ºå¤±çš„å‡½æ•°ï¼š`createChat`ã€`getMessages`ã€`sendMessage`

#### éƒ¨ç½²createChatå‡½æ•°ï¼š
1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·å·¦ä¾§æ–‡ä»¶æ ‘ä¸­æ‰¾åˆ° `cloudfunctions/createChat/`
2. **å³é”®ç‚¹å‡» `createChat` æ–‡ä»¶å¤¹**
3. é€‰æ‹© "ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ï¼ˆä¸ä¸Šä¼ node_modulesï¼‰"
4. ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆä¼šæ˜¾ç¤ºéƒ¨ç½²è¿›åº¦ï¼‰
5. éƒ¨ç½²æˆåŠŸåï¼Œåœ¨äº‘å¼€å‘æ§åˆ¶å°åˆ·æ–°é¡µé¢ç¡®è®¤å‡½æ•°å‡ºç°

#### éƒ¨ç½²sendMessageå‡½æ•°ï¼š
1. å³é”®ç‚¹å‡» `cloudfunctions/sendMessage/` æ–‡ä»¶å¤¹
2. é€‰æ‹© "ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ï¼ˆä¸ä¸Šä¼ node_modulesï¼‰"
3. ç­‰å¾…éƒ¨ç½²å®Œæˆ
4. åœ¨äº‘å¼€å‘æ§åˆ¶å°ç¡®è®¤

#### éƒ¨ç½²getMessageså‡½æ•°ï¼š
1. å³é”®ç‚¹å‡» `cloudfunctions/getMessages/` æ–‡ä»¶å¤¹
2. é€‰æ‹© "ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ï¼ˆä¸ä¸Šä¼ node_modulesï¼‰"
3. ç­‰å¾…éƒ¨ç½²å®Œæˆ
4. åœ¨äº‘å¼€å‘æ§åˆ¶å°ç¡®è®¤

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯éƒ¨ç½²ç»“æœ
1. åˆ·æ–°äº‘å¼€å‘æ§åˆ¶å°
2. ç¡®è®¤8ä¸ªäº‘å‡½æ•°éƒ½æ˜¾ç¤ºçŠ¶æ€ä¸º"æ­£å¸¸"ï¼š
   - âœ… login
   - âœ… createInvite  
   - âœ… joinByInvite
   - âœ… startConversation
   - âœ… checkChatStatus
   - ğŸ”¥ createChatï¼ˆæ–°éƒ¨ç½²ï¼‰
   - ğŸ”¥ getMessagesï¼ˆæ–°éƒ¨ç½²ï¼‰
   - ğŸ”¥ sendMessageï¼ˆæ–°éƒ¨ç½²ï¼‰

---

## ğŸ”¥ æ–¹æ³•2ï¼šåœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»º

å¦‚æœå¾®ä¿¡å¼€å‘è€…å·¥å…·éƒ¨ç½²ä»ç„¶ä¸æ˜¾ç¤ºï¼Œå¯ä»¥åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºï¼š

### ç¬¬ä¸€æ­¥ï¼šè¿›å…¥äº‘å¼€å‘æ§åˆ¶å°
1. åœ¨æµè§ˆå™¨æ‰“å¼€ï¼šhttps://console.cloud.tencent.com/tcb/scf
2. é€‰æ‹©ç¯å¢ƒï¼š`ququer-env-6g35f0nv28c446e7`
3. ç‚¹å‡»"äº‘å‡½æ•°"èœå•

### ç¬¬äºŒæ­¥ï¼šæ‰‹åŠ¨åˆ›å»ºcreateChatå‡½æ•°
1. ç‚¹å‡»"æ–°å»º"æŒ‰é’®
2. å‡½æ•°åç§°ï¼š`createChat`
3. è¿è¡Œç¯å¢ƒï¼š`Node.js 16.13`
4. åˆ›å»ºæ–¹å¼ï¼š`ç©ºç™½å‡½æ•°`
5. ç‚¹å‡»"ä¸‹ä¸€æ­¥"
6. å°†ä»¥ä¸‹ä»£ç å¤åˆ¶ç²˜è´´åˆ°ä»£ç ç¼–è¾‘å™¨ï¼š

```javascript
/**
 * åˆ›å»ºèŠå¤©äº‘å‡½æ•°
 * æ”¯æŒä¸¤ç§åˆ›å»ºæ–¹å¼ï¼š
 * 1. é€šè¿‡targetUserIdåˆ›å»ºï¼ˆæ”¯æŒè€ç‰ˆæœ¬æ¥å£ï¼‰
 * 2. é€šè¿‡chatIdç›´æ¥åˆ›å»ºï¼ˆæ”¯æŒæ–°ç‰ˆæœ¬æ¥å£ï¼‰
 */
const cloud = require('wx-server-sdk');

// åˆå§‹åŒ–äº‘ç¯å¢ƒ
cloud.init({
  env: 'ququer-env-6g35f0nv28c446e7'
});

// è·å–æ•°æ®åº“å¼•ç”¨
const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  console.log('[äº‘å‡½æ•°] createChat è¢«è°ƒç”¨ï¼Œå‚æ•°:', event);
  
  const wxContext = cloud.getWXContext();
  const userId = wxContext.OPENID;
  
  if (!userId) {
    return {
      success: false,
      error: 'è·å–ç”¨æˆ·IDå¤±è´¥'
    };
  }
  
  try {
    let chatId;
    let participantIds = [];
    
    // ç¡®å®šèŠå¤©IDå’Œå‚ä¸è€…
    if (event.chatId) {
      chatId = event.chatId;
      
      const existingChat = await db.collection('conversations').doc(chatId).get()
        .catch(() => ({ data: null }));
      
      if (existingChat.data) {
        const participants = existingChat.data.participants || [];
        
        if (!participants.includes(userId)) {
          participants.push(userId);
          await db.collection('conversations').doc(chatId).update({
            data: {
              participants: participants,
              updatedAt: db.serverDate()
            }
          });
        }
        
        return {
          success: true,
          chatId: chatId,
          exists: true,
          message: 'æˆåŠŸåŠ å…¥å·²å­˜åœ¨çš„èŠå¤©'
        };
      }
      
      participantIds = [userId];
    } else if (event.targetUserId) {
      const targetUserId = event.targetUserId;
      
      if (!targetUserId || targetUserId === userId) {
        return {
          success: false,
          error: 'æ— æ•ˆçš„ç›®æ ‡ç”¨æˆ·ID'
        };
      }
      
      participantIds = [userId, targetUserId].sort();
      chatId = participantIds.join('_');
      
      const existingChat = await db.collection('conversations').where({
        _id: chatId
      }).get();
      
      if (existingChat.data && existingChat.data.length > 0) {
        return {
          success: true,
          chatId: chatId,
          exists: true,
          message: 'èŠå¤©å·²å­˜åœ¨'
        };
      }
    } else {
      return {
        success: false,
        error: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼šchatIdæˆ–targetUserId'
      };
    }
    
    const timestamp = db.serverDate();
    
    await db.collection('conversations').add({
      data: {
        _id: chatId,
        participants: participantIds,
        createdBy: userId,
        createdAt: timestamp,
        updatedAt: timestamp,
        lastMessage: event.message || 'åˆ›å»ºäº†èŠå¤©',
        lastMessageTime: timestamp,
        status: 'active'
      }
    });
    
    if (event.message) {
      const messageId = `msg_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
      await db.collection('messages').add({
        data: {
          _id: messageId,
          chatId: chatId,
          senderId: userId,
          content: event.message,
          type: 'system',
          sendTime: timestamp,
          status: 'sent',
          destroyed: false
        }
      });
    }
    
    return {
      success: true,
      chatId: chatId,
      exists: false,
      message: 'æˆåŠŸåˆ›å»ºèŠå¤©'
    };
  } catch (error) {
    console.error('[äº‘å‡½æ•°] createChat æ‰§è¡Œå‡ºé”™:', error);
    
    return {
      success: false,
      error: error.message || 'åˆ›å»ºèŠå¤©å¤±è´¥'
    };
  }
};
```

7. ç‚¹å‡»"éƒ¨ç½²"æŒ‰é’®

### ç¬¬ä¸‰æ­¥ï¼šæ‰‹åŠ¨åˆ›å»ºsendMessageå‡½æ•°
1. ç‚¹å‡»"æ–°å»º"æŒ‰é’®
2. å‡½æ•°åç§°ï¼š`sendMessage`
3. è¿è¡Œç¯å¢ƒï¼š`Node.js 16.13`
4. å°†ä»¥ä¸‹ä»£ç å¤åˆ¶ç²˜è´´ï¼š

```javascript
const cloud = require('wx-server-sdk');
const crypto = require('crypto');

cloud.init({
  env: 'ququer-env-6g35f0nv28c446e7'
});

function encryptMessage(content, key) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv('aes-256-cbc', Buffer.from(key), iv);
  let encrypted = cipher.update(content, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return iv.toString('hex') + ':' + encrypted;
}

exports.main = async (event, context) => {
  console.log('å‘é€æ¶ˆæ¯äº‘å‡½æ•°è¢«è°ƒç”¨', event);
  
  if (!event.chatId || !event.content || !event.type) {
    return {
      success: false,
      error: 'å‚æ•°ä¸å®Œæ•´ï¼Œéœ€è¦chatIdã€contentå’Œtype'
    };
  }
  
  const wxContext = cloud.getWXContext();
  const senderId = wxContext.OPENID;
  
  const db = cloud.database();
  const messagesCollection = db.collection('messages');
  const conversationsCollection = db.collection('conversations');
  
  try {
    const messageId = `msg_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
    const encryptionKey = '0123456789abcdef0123456789abcdef';
    const encryptedContent = encryptMessage(event.content, encryptionKey);
    
    const messageData = {
      _id: messageId,
      chatId: event.chatId,
      senderId: senderId,
      receiverId: event.receiverId || 'group',
      type: event.type,
      content: encryptedContent,
      originalContent: event.type !== 'text' ? event.fileId : '',
      sendTime: db.serverDate(),
      status: 'sent',
      destroyed: false,
      viewTime: null,
      destroyTime: null,
      destroyTimeout: event.destroyTimeout || 10
    };
    
    await messagesCollection.add({
      data: messageData
    });
    
    const lastMessagePreview = event.type === 'text' ? 
      event.content.substring(0, 20) : 
      `[${event.type === 'image' ? 'å›¾ç‰‡' : (event.type === 'voice' ? 'è¯­éŸ³' : (event.type === 'video' ? 'è§†é¢‘' : 'æ¶ˆæ¯'))}]`;
    
    try {
      await conversationsCollection.doc(event.chatId).update({
        data: {
          lastMessage: lastMessagePreview,
          lastMessageTime: db.serverDate(),
          lastMessageSender: senderId,
          updateTime: db.serverDate()
        }
      });
    } catch (updateErr) {
      console.log('æ›´æ–°ä¼šè¯å¤±è´¥ï¼ˆä¼šè¯å¯èƒ½ä¸å­˜åœ¨ï¼‰:', updateErr.message);
    }
    
    return {
      success: true,
      messageId: messageId,
      chatId: event.chatId
    };
  } catch (err) {
    console.error('å‘é€æ¶ˆæ¯å‡ºé”™', err);
    return {
      success: false,
      error: err.message || 'å‘é€æ¶ˆæ¯å¤±è´¥'
    };
  }
};
```

5. ç‚¹å‡»"éƒ¨ç½²"

### ç¬¬å››æ­¥ï¼šæ‰‹åŠ¨åˆ›å»ºgetMessageså‡½æ•°
1. ç‚¹å‡»"æ–°å»º"æŒ‰é’®
2. å‡½æ•°åç§°ï¼š`getMessages`  
3. è¿è¡Œç¯å¢ƒï¼š`Node.js 16.13`
4. å°†ä»¥ä¸‹ä»£ç å¤åˆ¶ç²˜è´´ï¼š

```javascript
const cloud = require('wx-server-sdk');
const crypto = require('crypto');

cloud.init({
  env: 'ququer-env-6g35f0nv28c446e7'
});

function decryptMessage(encryptedContent, key) {
  try {
    const parts = encryptedContent.split(':');
    const iv = Buffer.from(parts[0], 'hex');
    const encrypted = parts[1];
    const decipher = crypto.createDecipheriv('aes-256-cbc', Buffer.from(key), iv);
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    return decrypted;
  } catch (err) {
    console.error('è§£å¯†æ¶ˆæ¯å¤±è´¥', err);
    return '[åŠ å¯†æ¶ˆæ¯]';
  }
}

exports.main = async (event, context) => {
  console.log('è·å–æ¶ˆæ¯äº‘å‡½æ•°è¢«è°ƒç”¨', event);
  
  if (!event.conversationId && !event.targetUserId && !event.chatId) {
    return {
      success: false,
      error: 'å‚æ•°ä¸å®Œæ•´ï¼Œéœ€è¦conversationIdã€targetUserIdæˆ–chatIdå…¶ä¸­ä¹‹ä¸€'
    };
  }
  
  const wxContext = cloud.getWXContext();
  const userId = wxContext.OPENID;
  
  const db = cloud.database();
  const _ = db.command;
  const messagesCollection = db.collection('messages');
  
  try {
    let queryCondition;
    
    if (event.chatId) {
      console.log('æŒ‰chatIdæŸ¥è¯¢æ¶ˆæ¯:', event.chatId);
      queryCondition = {
        chatId: event.chatId
      };
    } else if (event.targetUserId) {
      console.log('æŒ‰targetUserIdæŸ¥è¯¢æ¶ˆæ¯:', event.targetUserId);
      queryCondition = _.or([
        {
          senderId: userId,
          receiverId: event.targetUserId
        },
        {
          senderId: event.targetUserId,
          receiverId: userId
        }
      ]);
    } else if (event.conversationId) {
      console.log('æŒ‰conversationIdæŸ¥è¯¢æ¶ˆæ¯:', event.conversationId);
      const conversationParts = event.conversationId.split('_');
      if (!conversationParts.includes(userId)) {
        return {
          success: false,
          error: 'æ— æƒè®¿é—®è¯¥ä¼šè¯'
        };
      }
      
      queryCondition = _.or([
        {
          senderId: conversationParts[0],
          receiverId: conversationParts[1]
        },
        {
          senderId: conversationParts[1],
          receiverId: conversationParts[0]
        }
      ]);
    }
    
    let messagesQuery = messagesCollection
      .where(queryCondition)
      .orderBy('sendTime', 'desc');
    
    if (event.limit) {
      messagesQuery = messagesQuery.limit(event.limit);
    } else {
      messagesQuery = messagesQuery.limit(50);
    }
    
    const messagesResult = await messagesQuery.get();
    console.log(`æŸ¥è¯¢åˆ° ${messagesResult.data.length} æ¡æ¶ˆæ¯`);
    
    const encryptionKey = '0123456789abcdef0123456789abcdef';
    const messages = messagesResult.data.map(msg => {
      const processedMsg = { ...msg };
      
      if (!msg.destroyed && msg.type === 'text' && msg.content) {
        try {
          processedMsg.content = decryptMessage(msg.content, encryptionKey);
        } catch (err) {
          console.error('è§£å¯†æ¶ˆæ¯å¤±è´¥', err);
          processedMsg.content = msg.content;
        }
      } else if (msg.destroyed) {
        processedMsg.content = '';
      } else if (msg.type === 'system') {
        processedMsg.content = msg.content;
      }
      
      return processedMsg;
    });
    
    messages.reverse();
    
    return {
      success: true,
      messages: messages,
      count: messages.length,
      queryType: event.chatId ? 'chatId' : (event.targetUserId ? 'targetUserId' : 'conversationId')
    };
  } catch (err) {
    console.error('è·å–æ¶ˆæ¯åˆ—è¡¨å‡ºé”™', err);
    return {
      success: false,
      error: err.message || 'è·å–æ¶ˆæ¯å¤±è´¥'
    };
  }
};
```

5. ç‚¹å‡»"éƒ¨ç½²"

---

## ğŸ”¥ æ–¹æ³•3ï¼šå‘½ä»¤è¡Œå¼ºåˆ¶é‡æ–°éƒ¨ç½²

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ•ˆï¼Œä½¿ç”¨å‘½ä»¤è¡Œå¼ºåˆ¶é‡æ–°éƒ¨ç½²ï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd "/Users/tedsmini/Desktop/app design/ququer"

# 2. å®‰è£…cloudbase CLIï¼ˆå¦‚æœæ²¡æœ‰å®‰è£…ï¼‰
npm install -g @cloudbase/cli

# 3. ç™»å½•
cloudbase login

# 4. å¼ºåˆ¶é‡æ–°éƒ¨ç½²ä¸‰ä¸ªå‡½æ•°
cloudbase functions:deploy createChat --env ququer-env-6g35f0nv28c446e7 --force
cloudbase functions:deploy sendMessage --env ququer-env-6g35f0nv28c446e7 --force  
cloudbase functions:deploy getMessages --env ququer-env-6g35f0nv28c446e7 --force

# 5. éªŒè¯éƒ¨ç½²
cloudbase functions:list --env ququer-env-6g35f0nv28c446e7
```

---

## âœ… éªŒè¯éƒ¨ç½²æˆåŠŸ

### åœ¨äº‘å¼€å‘æ§åˆ¶å°éªŒè¯ï¼š
1. åˆ·æ–°é¡µé¢
2. ç¡®è®¤çœ‹åˆ°8ä¸ªäº‘å‡½æ•°ï¼ŒçŠ¶æ€éƒ½ä¸º"æ­£å¸¸"
3. ç‚¹å‡»æ¯ä¸ªå‡½æ•°åï¼Œç¡®è®¤ä»£ç æ­£ç¡®æ˜¾ç¤º

### åœ¨å°ç¨‹åºä¸­æµ‹è¯•ï¼š
1. é‡å¯å°ç¨‹åºï¼ˆå®Œå…¨å…³é—­å†é‡æ–°è¿›å…¥ï¼‰
2. å°è¯•å‘é€æ¶ˆæ¯
3. æŸ¥çœ‹è°ƒè¯•æ§åˆ¶å°ï¼Œç¡®è®¤æ²¡æœ‰-501000é”™è¯¯

---

## ğŸ†˜ å¦‚æœä»ç„¶æ— æ³•è§£å†³

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. äº‘å¼€å‘æ§åˆ¶å°æˆªå›¾ï¼ˆæ˜¾ç¤ºå½“å‰äº‘å‡½æ•°çŠ¶æ€ï¼‰
2. å¾®ä¿¡å¼€å‘è€…å·¥å…·éƒ¨ç½²æ—¶çš„å®Œæ•´é”™è¯¯æ—¥å¿—
3. å°ç¨‹åºè°ƒè¯•æ§åˆ¶å°çš„æœ€æ–°é”™è¯¯ä¿¡æ¯

æˆ‘ä¼šæ ¹æ®å…·ä½“é”™è¯¯æƒ…å†µæä¾›è¿›ä¸€æ­¥çš„è§£å†³æ–¹æ¡ˆã€‚ 