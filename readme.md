# 秘信 - 阅后即焚小程序

## 项目介绍

秘信是一款阅后即焚的微信小程序，用户可以发送带有自动销毁功能的消息（文字、图片、语音、视频等）。接收方查看消息后，消息会自动销毁，同时从双方设备和服务器端删除，以保护信息隐私和安全。

## 核心功能

- **用户认证与管理**：集成微信登录，获取用户openId作为唯一标识
- **实时聊天**：支持发送文字、图片、语音、视频等多媒体消息
- **阅后即焚机制**：接收者查看消息后启动销毁倒计时，倒计时结束后自动删除该条消息
- **消息提醒**：通过小程序云函数或微信模板消息推送新消息提醒
- **安全保护**：消息加密存储、防截屏提醒等隐私保护措施

## 技术架构

- 前端：微信小程序原生框架
- 后端：微信小程序云开发（云函数、云数据库、云存储）
- 安全：AES加密、HTTPS传输、定时数据清理

## 项目结构

```
|- app.js               # 小程序入口文件
|- app.json             # 小程序全局配置
|- app.wxss             # 小程序全局样式
|- assets/              # 静态资源目录
|  |- images/           # 图片资源
|- app/                 # 应用目录
|  |- pages/            # 页面文件
|  |  |- login/         # 登录页面
|  |  |- home/          # 首页/会话列表
|  |  |- chat/          # 聊天页面
|  |  |- test-share/    # 测试页面
|  |- components/       # 自定义组件
|  |  |- message        # 消息组件
|  |- service/          # 服务模块
|  |  |- api.js         # 云函数API接口
|- cloudfunctions/      # 云函数目录
|  |- login/            # 登录云函数
|  |- sendMessage/      # 发送消息云函数
|  |- getMessages/      # 获取消息云函数
|  |- destroyMessage/   # 销毁消息云函数
|  |- getConversations/ # 获取会话列表云函数
```

## 使用说明

1. 克隆项目到本地
2. 使用微信开发者工具打开项目
3. 在微信开发者工具中配置自己的AppID
4. 开通云开发，创建云环境（当前使用的云环境ID: `ququer-env-6g35f0nv28c446e7`）
5. 上传并部署云函数，同时在云数据库中创建以下集合：
   - `users`: 存储用户信息（头像、昵称、登录时间）
   - `messages`: 存储聊天消息
   - `conversations`: 存储会话信息
6. 如需修改云环境ID，请更新以下文件：
   - `app.js`中的`wx.cloud.init`配置
   - `app/service/api.js`中的`initCloud`函数

## 安全注意事项

- 本项目使用微信提供的加密API保护消息内容
- 用户查看消息后会自动销毁，无法找回
- 为保护隐私，请不要在应用中分享敏感信息
- 由于小程序技术限制，无法100%防止截屏，但会对截屏行为进行提醒

## 开发团队

- 开发者：秘信团队
- 联系邮箱：contact@example.com

## 版本记录

- v1.0.0（2023-06-01）：初始版本发布
- v1.1.0（2023-12-15）：添加云开发支持，实现用户数据存储和消息加密功能
- v1.3.34（2025-01-05）：修复a端反复加载消息问题，优化轮询频率和加载状态管理
- v1.3.35（2025-01-05）：双端连接检测后台静默化，移除所有连接检测相关的UI提示
- v1.3.36（2025-01-05）：修复a端连接提示重复问题，移除"建立了聊天"系统消息
- v1.3.37（2025-01-05）：彻底解决a端连接提示重复问题，统一为"朋友已加入聊天"
- v1.3.50（2025-09-25）：B端双重系统消息终极修复，完善防重复机制
- v1.3.51（2025-09-26）：B端系统消息和标题刷新修复，连接后立即刷新
- v1.3.52（2025-09-27）：修复B端系统消息重复显示问题，移除重复调用
- v1.3.53（2025-09-28）：智能聊天检测和B端身份识别修复，支持继续现有聊天
- v1.3.54（2025-09-30）：修复B端系统消息Promise错误，移除B端消息自动删除机制

## 📋 最新修复记录

### HOTFIX-v1.3.54 - B端系统消息Promise错误和自动删除修复（当前版本）
- **问题**：B端系统消息中fetchChatParticipantsWithRealNames方法被错误调用.then()导致Promise错误，同时B端系统消息因autoFadeStaySeconds参数被快速自动删除
- **修复**：1）修复Promise调用方式，改为setTimeout异步处理；2）移除B端系统消息的autoFadeStaySeconds参数，确保"加入xx的聊天"提示能正常显示给用户；3）增强真实昵称获取逻辑
- **影响**：B端系统消息显示更稳定准确，用户能看到完整的加入提示，不会被快速删除
- **状态**：✅ 已完成

### HOTFIX-v1.3.53 - 智能聊天检测和B端身份识别
- **问题**：用户登录时没有邀请信息但存在现有聊天时，总是创建新聊天
- **修复**：1）实现智能聊天检测机制，自动询问用户是否继续现有聊天；2）增强B端身份识别逻辑；3）改进B端系统消息处理
- **影响**：用户能够智能恢复现有聊天，避免重复创建新聊天
- **状态**：✅ 已完成

### HOTFIX-v1.3.52 - B端系统消息重复问题修复
- **问题**：B端系统消息重复显示，在确认B端身份后立即调用updateSystemMessageAfterJoin函数导致重复
- **修复**：移除第458行重复调用，加强防重复机制
- **影响**：B端系统消息只显示一次"加入xx的聊天"，彻底解决双重系统消息问题
- **状态**：✅ 已完成

### HOTFIX-v1.3.37 - a端连接提示重复修复 v2（彻底版）
- **问题**：a端连接成功后存在多个重复提示："🎉 好友已加入聊天"、"已连接xxx"、"好友已加入！"
- **修复**：移除所有重复提示，统一为单一提示"朋友已加入聊天"
- **影响**：彻底消除重复提示困扰，统一用户反馈，简化提示文案
- **状态**：✅ 已完成

### HOTFIX-v1.3.36 - a端连接提示重复修复
- **问题**：a端建立连接时会出现两次提示："好朋友已加入聊天"和"已建立连接"
- **修复**：保留Toast提示"好朋友已加入聊天"，移除系统消息"和xxx建立了聊天"
- **影响**：消除重复提示，改善用户体验，不影响接收方和其他系统消息
- **状态**：✅ 已完成

### HOTFIX-v1.3.35 - 双端连接检测后台静默修复
- **问题**：双端连接检测会弹出各种Toast提示和Modal对话框，影响用户体验
- **修复**：将所有连接检测相关的UI提示改为后台静默，包括连接修复、权限检查、参与者修复等
- **影响**：移除11个Toast提示、1个Modal对话框，所有连接检测和修复都在后台静默进行
- **状态**：✅ 已完成

### HOTFIX-v1.3.34 - a端反复加载消息修复
- **问题**：a端会反复提示"加载消息中"，用户体验很差
- **原因**：时间戳解析错误、消息身份判断错误、轮询过于频繁、重复销毁检查、加载状态管理不当
- **修复**：修复时间戳解析逻辑、消息身份判断、优化轮询频率、添加重复销毁检查、改进加载状态管理
- **状态**：✅ 已完成

### HOTFIX-v1.3.33 - 标题显示修复
- **问题**：聊天标题显示异常，发送方显示"我和用户（2）"而不是正确的昵称
- **修复**：优化标题显示逻辑，正确获取和显示对方昵称
- **状态**：✅ 已完成