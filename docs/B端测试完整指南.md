# B端测试完整指南 - 获取B端日志

## 🎯 目标

获取真实的B端日志,验证B端系统消息是否像A端一样自动淡出消失。

---

## 方法一:微信开发者工具 - 双窗口测试(最简单)

### 第一步:A端窗口 - 创建聊天

1. **打开微信开发者工具**
   - 打开项目: `/Users/tedsmini/Desktop/app design/ququer`
   - AppID: `wx1848888960aefcb5`

2. **正常编译运行**
   - 点击"编译"
   - 登录账号(例如:向冬)
   - 创建聊天
   - 看到系统消息:"您创建了私密聊天..."

3. **记录chatId**
   - 在Console中搜索: `chatId:`
   - 复制完整的chatId,例如: `chat_1759821214735_ikyy8g9u6`

### 第二步:B端窗口 - 加入聊天

1. **保持A端窗口打开,新建第二个开发者工具窗口**
   - 在微信开发者工具中: `文件` → `新建窗口`
   - 或者直接再次打开微信开发者工具

2. **在新窗口中打开同一个项目**
   - 导入项目: `/Users/tedsmini/Desktop/app design/ququer`
   - AppID: `wx1848888960aefcb5`

3. **配置B端编译模式**
   - 点击"编译"旁边的下拉箭头
   - 选择"添加编译模式"
   - 填写如下:
   
   ```
   模式名称: B端加入测试
   启动页面: app/pages/login/login
   启动参数: (使用步骤1记录的chatId)
   
   scene=1044&chatId=chat_1759821214735_ikyy8g9u6&inviter=%E5%90%91%E5%86%AC&fromInvite=true
   ```
   
   > 注意: `%E5%90%91%E5%86%AC` 是"向冬"的URL编码

4. **编译并登录**
   - 选择刚创建的"B端加入测试"模式
   - 点击"编译"
   - 使用**不同的账号**登录(例如:Y.)
   - **不要使用A端的账号!**

5. **观察B端行为**
   - 应该自动跳转到聊天页面
   - 标题显示为: "向冬" (A端用户名)
   - **关键**: 观察是否出现系统消息"加入向冬的聊天"
   - **关键**: 观察该消息是否在8秒后自动淡出消失

### 第三步:复制B端日志

1. **在B端窗口的Console面板**
   - Cmd+A (全选)
   - Cmd+C (复制)
   - 粘贴给我

2. **验证日志是否为B端**
   - 搜索 `isFromInvite:`
   - 如果是 `isFromInvite: true` → ✅ 这是B端日志
   - 如果是 `isFromInvite: false` → ❌ 这是A端日志,请重新操作

---

## 方法二:真机测试(最准确)

### 需要准备

- 📱 设备A: iPhone/Android (登录账号A,例如:向冬)
- 📱 设备B: iPhone/Android (登录账号B,例如:Y.)
- 💻 电脑: 安装微信开发者工具

### 步骤

1. **设备A: 创建并分享**
   - 打开"秘信"小程序
   - 创建聊天
   - 点击右上角"..."→"发送给朋友"
   - 发送给设备B的微信

2. **设备B: 接收并加入**
   - 点击小程序链接
   - 授权登录
   - 自动进入聊天

3. **设备B: 开启调试**
   - **iOS**: 设置 → 通用 → 功能 → 微信开发者工具 → 开启调试
   - **Android**: 设置 → 关于微信 → 连续点击7次开启开发者模式

4. **电脑: 远程调试**
   - 开发者工具 → 工具 → 远程调试
   - 扫码连接设备B
   - 在设备B上打开小程序
   - 在电脑Console中查看日志

---

## 🔍 B端日志识别清单

### ✅ 必须包含的关键标记

```javascript
// 1. B端身份标记
🔥 [身份判断] 保存用户身份: {
  isFromInvite: true,   // ✅ 必须是true
  isSender: false       // ✅ 必须是false
}

// 2. 邀请流程
[邀请流程] 检测到本地存储的邀请: {inviteId: "chat_xxx", chatId: "chat_xxx", inviter: "向冬", fromInvite: true}

// 3. B端系统消息添加
👥 [B端系统消息-v1.3.82] 准备添加B端消息: 加入向冬的聊天
👥 [B端系统消息-v1.3.82] ✅ B端消息已添加（带淡出）: 加入向冬的聊天

// 4. 系统消息淡出(如果正常工作)
🔥 [系统消息销毁-v1.3.78] 停留时间结束，开始渐隐: sys_xxx
🔥 [透明度渐变-v1.3.78] 开始透明度渐变销毁: sys_xxx 时长: 5 秒
🔥 [透明度渐变-v1.3.78] CSS transition完成，开始彻底删除消息: sys_xxx
🗑️ [彻底删除] 永久删除消息: sys_xxx

// 5. B端标题
🏷️ [优化标题] B端标题设置为: 向冬
```

### ❌ 不应该出现的A端标记

```javascript
// ❌ 这些是A端特征,不应该在B端日志中出现
isFromInvite: false
isSender: true
[a端系统消息-v1.3.83] A端本地添加创建消息
您创建了私密聊天，可点击右上角菜单分享链接邀请朋友加入
为新用户创建聊天ID: chat_xxx
```

---

## 🐛 可能的问题场景

### 场景1: B端没有出现系统消息

**症状**: B端进入聊天后,没有看到"加入XX的聊天"消息

**日志特征**:
- 有 `isFromInvite: true`
- 但没有 `[B端系统消息-v1.3.82] 准备添加B端消息`

**可能原因**:
1. 身份判断被跳过
2. 防重复标记误触发
3. `fetchChatParticipantsWithRealNames` 未被调用

**搜索关键字**:
```
[B端系统消息]
fetchChatParticipantsWithRealNames
isDefinitelyBSide
bEndSystemMessageProcessed
```

---

### 场景2: B端系统消息出现但不消失

**症状**: "加入XX的聊天"消息一直显示,不会淡出

**日志特征**:
- 有 `[B端系统消息-v1.3.82] ✅ B端消息已添加（带淡出）`
- 但没有 `[系统消息销毁-v1.3.78] 停留时间结束，开始渐隐`

**可能原因**:
1. `startSystemMessageFade` 未被调用
2. 定时器被清除
3. 消息ID丢失

**搜索关键字**:
```
startSystemMessageFade
系统消息销毁
透明度渐变
```

---

### 场景3: B端系统消息出现多次

**症状**: 看到2个或3个"加入XX的聊天"消息

**日志特征**:
- 多次出现 `[B端系统消息-v1.3.82] 准备添加B端消息`

**可能原因**:
1. 防重复标记未生效
2. `fetchChatParticipantsWithRealNames` 被多次调用
3. 云端消息与本地消息重复

**搜索关键字**:
```
B端防重复
bEndSystemMessageProcessed
轮询防重复
```

---

## 📝 日志提交清单

请提供以下信息:

### 1. 基本信息
- [ ] 使用的测试方法(方法一/方法二)
- [ ] A端账号昵称
- [ ] B端账号昵称
- [ ] chatId

### 2. 现象描述
- [ ] B端是否出现系统消息
- [ ] 系统消息内容是什么
- [ ] 系统消息是否消失
- [ ] 消失时间(如果消失了)
- [ ] 是否出现多个系统消息

### 3. 完整日志
- [ ] B端的完整Console日志(从启动到进入聊天后15秒)

### 4. 身份验证
- [ ] 日志中 `isFromInvite` 的值
- [ ] 日志中 `isSender` 的值

---

## 🚀 快速测试命令

我已经为您准备了URL编码工具:

```bash
# 获取URL编码的邀请者名称
python3 << EOF
import urllib.parse
inviter = "向冬"  # 修改为实际的A端昵称
print("URL编码:", urllib.parse.quote(inviter))
EOF
```

然后使用输出结果配置编译模式的启动参数:
```
scene=1044&chatId=实际的chatId&inviter=URL编码结果&fromInvite=true
```

---

## ✅ 成功标志

当您成功获取B端日志后,应该能回答以下问题:

1. ✅ B端是否出现了"加入XX的聊天"系统消息?
2. ✅ 该消息是否在8秒后自动淡出消失?
3. ✅ 日志中是否有 `[系统消息销毁]` 相关的日志?

如果答案都是"是",说明B端工作正常!

如果有任何一个是"否",请提供完整日志,我会定位具体问题。

