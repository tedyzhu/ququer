# 手动部署sendMessage-v1.3.28修复指南

## 问题概述
a的标题更新了，但显示的是错误的昵称格式："我和向冬（2）"（显示的是a自己的昵称），应该显示为"我和[b的真实昵称]（2）"。

## 修复内容
✅ **已完成修复**：
1. 修复了`sendMessage`云函数获取用户信息的逻辑
2. 修复了前端传递用户信息的逻辑
3. 优先使用前端传递的当前用户信息，避免从users集合获取错误昵称

## 部署步骤

### 方法1：使用微信开发者工具（推荐）

1. **打开微信开发者工具**
   - 确保已登录并选择正确的项目

2. **进入云开发控制台**
   - 点击工具栏的"云开发"按钮
   - 选择环境：`ququer-env-6g35f0nv28c446e7`

3. **部署sendMessage云函数**
   - 在左侧菜单选择"云函数"
   - 找到`sendMessage`云函数
   - 点击该函数右侧的"部署"按钮
   - 等待部署完成（约1-2分钟）

4. **验证部署成功**
   - 部署完成后，查看函数列表中`sendMessage`的状态
   - 确认显示为"已部署"或"运行中"

### 方法2：使用云开发控制台

1. **访问微信云开发控制台**
   - 打开 [https://console.cloud.weixin.qq.com](https://console.cloud.weixin.qq.com)
   - 使用微信扫码登录

2. **选择环境和项目**
   - 选择环境：`ququer-env-6g35f0nv28c446e7`
   - 选择对应的小程序项目

3. **上传并部署**
   - 在"云函数"页面找到`sendMessage`
   - 点击"上传"或"重新部署"
   - 选择本地的`cloudfunctions/sendMessage`目录
   - 确认上传并等待部署完成

### 方法3：使用命令行（如果可用）

```bash
# 在项目根目录执行
./deploy-sendMessage-hotfix-v1.3.28.sh
```

## 测试验证

### 测试步骤

1. **a创建聊天**
   - a用户创建一个新的聊天
   - 分享聊天链接给b用户

2. **b加入聊天**
   - b用户点击链接加入聊天
   - 确认成功进入聊天界面

3. **b发送消息**
   - b用户发送一条测试消息
   - 例如："你好，我是b"

4. **检查a的标题**
   - 观察a用户的聊天标题
   - 应该显示："我和[b的真实昵称]（2）"
   - 而不是："我和向冬（2）"

### 预期效果

**修复前**：
- 标题显示："我和向冬（2）"（错误：显示的是a的昵称）

**修复后**：
- 标题显示："我和[b的真实昵称]（2）"（正确：显示的是b的真实昵称）

## 故障排查

### 如果标题仍显示错误昵称

1. **检查云函数部署**
   ```
   确认sendMessage云函数已成功部署到云端
   ```

2. **检查前端代码**
   ```
   确认app/pages/chat/chat.js中的sendMessage函数已包含currentUserInfo参数
   ```

3. **清除缓存**
   ```
   在微信开发者工具中：
   - 点击"清缓存" -> "清除数据缓存"
   - 重新编译项目
   ```

4. **重新测试**
   ```
   创建新的聊天进行测试，避免使用旧的聊天记录
   ```

### 如果云函数部署失败

1. **检查网络连接**
   - 确保网络正常，能够访问微信云开发服务

2. **检查权限设置**
   - 确认账号有云函数部署权限
   - 确认选择了正确的环境ID

3. **检查依赖安装**
   ```bash
   cd cloudfunctions/sendMessage
   npm install
   ```

4. **使用备用部署方法**
   - 尝试不同的部署方法（开发者工具 vs 云控制台）

## 技术细节

### 修复原理

1. **问题根源**：
   - 当b发送消息时，sendMessage云函数从users集合获取b的用户信息
   - 但users集合中可能包含错误的昵称数据
   - 导致participants列表中b的昵称错误

2. **修复方法**：
   - 前端在调用sendMessage时传递`currentUserInfo`参数
   - 云函数优先使用前端传递的用户信息
   - 只有在前端信息不可用时才从users集合获取

3. **数据流**：
   ```
   前端发送消息 -> 传递currentUserInfo -> 云函数使用正确昵称 -> 更新participants -> 触发标题更新
   ```

### 代码变更概览

**sendMessage云函数**：
- 添加了优先使用`event.currentUserInfo`的逻辑
- 保留了从users集合获取信息的备用方案

**前端聊天页面**：
- 在调用sendMessage云函数时添加了`currentUserInfo`参数传递

## 完成确认

部署完成后，请确认以下几点：

- [ ] sendMessage云函数部署成功
- [ ] b发送消息后，a的标题正确显示为"我和[b的真实昵称]（2）"
- [ ] 双方消息收发正常
- [ ] 不再出现"我和向冬（2）"的错误格式

---

**修复版本**: HOTFIX-v1.3.28  
**修复时间**: 2024-01-04  
**影响范围**: sendMessage云函数、聊天标题显示  
**部署要求**: 必须重新部署sendMessage云函数 