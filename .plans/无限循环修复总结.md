# ğŸ›¡ï¸ ç§˜ä¿¡å°ç¨‹åºæ— é™å¾ªç¯é—®é¢˜ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

åœ¨æµ‹è¯•é‚€è¯·é“¾æ¥åŠŸèƒ½æ—¶ï¼Œå‘ç°èŠå¤©é¡µé¢å‡ºç°ä¸¥é‡çš„æ— é™å¾ªç¯é—®é¢˜ï¼Œè¡¨ç°ä¸ºï¼š

1. æ§åˆ¶å°è¾“å‡ºå¤§é‡é‡å¤çš„æ—¥å¿—ä¿¡æ¯
2. ç›¸åŒçš„å‡½æ•°è¢«åå¤è°ƒç”¨ï¼Œå¯¼è‡´æ€§èƒ½é—®é¢˜
3. é¡µé¢å¯èƒ½å‡ºç°å¡é¡¿æˆ–å†…å­˜æ³„æ¼

## é—®é¢˜æ ¹æºåˆ†æ

é€šè¿‡æ—¥å¿—åˆ†æï¼Œå‘ç°æ— é™å¾ªç¯æ˜¯ç”±ä»¥ä¸‹è°ƒç”¨é“¾é€ æˆçš„ï¼š

```
loadMessages() 
   â†“
loadChatInfo() 
   â†“  
handleChatStatus('active')
   â†“
this.loadMessages()  â† é‡æ–°å›åˆ°èµ·ç‚¹ï¼Œå½¢æˆå¾ªç¯
```

### å…·ä½“è§¦å‘æ¡ä»¶

1. å…¨å±€æ•°æ® `app.globalData.chats` ä¸­å­˜åœ¨çŠ¶æ€ä¸º `active` çš„èŠå¤©ä¿¡æ¯
2. `loadChatInfo()` ä»å…¨å±€æ•°æ®è·å–åˆ°èŠå¤©ä¿¡æ¯
3. æ£€æµ‹åˆ° `status: 'active'`ï¼Œè°ƒç”¨ `handleChatStatus('active')`
4. `handleChatStatus` ä¸­çš„ `case 'active'` åˆ†æ”¯è°ƒç”¨ `this.loadMessages()`
5. `loadMessages()` åˆè°ƒç”¨ `loadChatInfo()`ï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ çŠ¶æ€é‡å¤æ£€æŸ¥æœºåˆ¶

åœ¨ `handleChatStatus` å‡½æ•°ä¸­æ·»åŠ é˜²é‡å¤å¤„ç†é€»è¾‘ï¼š

```javascript
handleChatStatus: function(status) {
  // é˜²æ­¢æ— é™å¾ªç¯ï¼šå¦‚æœå½“å‰çŠ¶æ€å·²ç»å¤„ç†è¿‡ï¼Œåˆ™è·³è¿‡
  if (this._lastHandledStatus === status) {
    console.log('[é‚€è¯·æµç¨‹] çŠ¶æ€å·²å¤„ç†è¿‡ï¼Œè·³è¿‡é‡å¤å¤„ç†:', status);
    return;
  }
  this._lastHandledStatus = status;
  
  // ... å…¶ä½™å¤„ç†é€»è¾‘
}
```

### 2. ç§»é™¤å¯¼è‡´å¾ªç¯çš„å‡½æ•°è°ƒç”¨

ç§»é™¤ `handleChatStatus` ä¸­ `case 'active'` åˆ†æ”¯é‡Œçš„ `this.loadMessages()` è°ƒç”¨ï¼š

```javascript
case 'active':
  // èŠå¤©å·²æ¿€æ´»ï¼Œæ·»åŠ æç¤º
  this.addSystemMessage('èŠå¤©å·²å»ºç«‹ï¼Œå¯ä»¥å¼€å§‹å¯¹è¯äº†');
  // ğŸš« ç§»é™¤è¿™é‡Œçš„ loadMessages è°ƒç”¨ï¼Œé˜²æ­¢æ— é™å¾ªç¯
  // this.loadMessages();
  console.log('[é‚€è¯·æµç¨‹] èŠå¤©çŠ¶æ€ä¸º activeï¼Œæ— é™å¾ªç¯å·²ä¿®å¤');
  break;
```

### 3. æ·»åŠ è°ƒç”¨é¢‘ç‡é™åˆ¶

åœ¨ `loadChatInfo` å‡½æ•°ä¸­æ·»åŠ é˜²é‡å¤è°ƒç”¨æœºåˆ¶ï¼š

```javascript
loadChatInfo: function() {
  // é˜²æ­¢é‡å¤è°ƒç”¨ï¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½æˆ–æœ€è¿‘åˆšåŠ è½½è¿‡
  if (this._isLoadingChatInfo) {
    console.log('[é‚€è¯·æµç¨‹] èŠå¤©ä¿¡æ¯æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
    return Promise.resolve(null);
  }
  
  if (this._lastChatInfoLoadTime && Date.now() - this._lastChatInfoLoadTime < 1000) {
    console.log('[é‚€è¯·æµç¨‹] 1ç§’å†…é‡å¤è°ƒç”¨ loadChatInfoï¼Œè·³è¿‡');
    return Promise.resolve(null);
  }
  
  this._isLoadingChatInfo = true;
  this._lastChatInfoLoadTime = Date.now();
  
  // ... å…¶ä½™åŠ è½½é€»è¾‘
}
```

### 4. å®Œå–„çŠ¶æ€é‡ç½®æœºåˆ¶

åœ¨é¡µé¢ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­é‡ç½®é˜²æŠ¤æ ‡å¿—ï¼š

```javascript
onLoad: function (options) {
  // ğŸ›¡ï¸ åˆå§‹åŒ–é˜²å¾ªç¯æ ‡å¿—
  this._isLoadingChatInfo = false;
  this._lastHandledStatus = null;
  this._lastChatInfoLoadTime = 0;
  console.log('[é‚€è¯·æµç¨‹] ğŸ›¡ï¸ æ— é™å¾ªç¯é˜²æŠ¤æœºåˆ¶å·²å¯åŠ¨');
  
  // ... å…¶ä½™åˆå§‹åŒ–é€»è¾‘
}

onUnload: function() {
  // é‡ç½®é˜²å¾ªç¯æ ‡å¿—
  this._isLoadingChatInfo = false;
  this._lastHandledStatus = null;
  this._lastChatInfoLoadTime = 0;
  
  // ... å…¶ä½™æ¸…ç†é€»è¾‘
}
```

## ä¿®å¤æ•ˆæœéªŒè¯

### æµ‹è¯•æ–¹æ³•

1. åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•é¡µé¢ `app/pages/test-fix/`
2. æ¨¡æ‹Ÿè§¦å‘æ— é™å¾ªç¯çš„æ¡ä»¶
3. è§‚å¯Ÿæ˜¯å¦è¿˜æœ‰é‡å¤çš„æ—¥å¿—è¾“å‡º

### é¢„æœŸç»“æœ

ä¿®å¤æˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

1. ğŸ›¡ï¸ æ— é™å¾ªç¯é˜²æŠ¤æœºåˆ¶å·²å¯åŠ¨
2. èŠå¤©çŠ¶æ€ä¸º activeï¼Œæ— é™å¾ªç¯å·²ä¿®å¤  
3. çŠ¶æ€å·²å¤„ç†è¿‡ï¼Œè·³è¿‡é‡å¤å¤„ç†
4. ä¸å†æœ‰é‡å¤çš„æ—¥å¿—è¾“å‡º

## ä¿®å¤æ–‡ä»¶æ¸…å•

### ä¸»è¦ä¿®å¤æ–‡ä»¶

- `pages/chat/chat.js` - ä¸»è¦ä¿®å¤æ–‡ä»¶ï¼Œæ·»åŠ äº†é˜²å¾ªç¯æœºåˆ¶

### æ–°å¢æµ‹è¯•æ–‡ä»¶

- `app/pages/test-fix/test-fix.js` - æµ‹è¯•é¡µé¢é€»è¾‘
- `app/pages/test-fix/test-fix.wxml` - æµ‹è¯•é¡µé¢æ¨¡æ¿  
- `app/pages/test-fix/test-fix.wxss` - æµ‹è¯•é¡µé¢æ ·å¼
- `app/pages/test-fix/test-fix.json` - æµ‹è¯•é¡µé¢é…ç½®

## æŠ€æœ¯è¦ç‚¹

### é˜²æŠ¤æœºåˆ¶è®¾è®¡åŸç†

1. **çŠ¶æ€æ ‡è®°**: ä½¿ç”¨ `_lastHandledStatus` è®°å½•æœ€åå¤„ç†çš„çŠ¶æ€
2. **æ—¶é—´çª—å£**: ä½¿ç”¨ `_lastChatInfoLoadTime` é™åˆ¶è°ƒç”¨é¢‘ç‡
3. **åŠ è½½é”**: ä½¿ç”¨ `_isLoadingChatInfo` é˜²æ­¢å¹¶å‘åŠ è½½
4. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: åœ¨é¡µé¢åŠ è½½å’Œå¸è½½æ—¶é‡ç½®æ ‡å¿—

### ä»£ç å¥å£®æ€§æ”¹è¿›

1. åœ¨æ‰€æœ‰å¯èƒ½çš„é”™è¯¯åˆ†æ”¯éƒ½é‡ç½®åŠ è½½æ ‡å¿—
2. æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥
3. ä¿æŒåŸæœ‰åŠŸèƒ½ä¸å˜ï¼Œåªæ˜¯é˜»æ­¢æ— é™å¾ªç¯

## åç»­å»ºè®®

1. **å…¨é¢æµ‹è¯•**: åœ¨ä¸åŒåœºæ™¯ä¸‹æµ‹è¯•é‚€è¯·é“¾æ¥åŠŸèƒ½
2. **æ€§èƒ½ç›‘æ§**: è§‚å¯Ÿä¿®å¤åçš„å†…å­˜ä½¿ç”¨å’Œé¡µé¢æ€§èƒ½
3. **ä»£ç å®¡æŸ¥**: æ£€æŸ¥å…¶ä»–é¡µé¢æ˜¯å¦æœ‰ç±»ä¼¼çš„å¾ªç¯è°ƒç”¨é—®é¢˜
4. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°å¼€å‘æ–‡æ¡£ï¼Œè®°å½•é˜²å¾ªç¯ç¼–ç¨‹æœ€ä½³å®è·µ

## ç»“è®º

é€šè¿‡å¤šå±‚é˜²æŠ¤æœºåˆ¶ï¼ŒæˆåŠŸè§£å†³äº†èŠå¤©é¡µé¢çš„æ— é™å¾ªç¯é—®é¢˜ã€‚ä¿®å¤æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- âœ… **å®‰å…¨å¯é **: å¤šé‡é˜²æŠ¤ï¼Œç¡®ä¿ä¸ä¼šå‡ºç°æ–°çš„å¾ªç¯
- âœ… **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½çš„æ­£å¸¸ä½¿ç”¨  
- âœ… **æ˜“äºç»´æŠ¤**: ä»£ç æ¸…æ™°ï¼Œä¾¿äºåç»­ç»´æŠ¤å’Œæ‰©å±•
- âœ… **å¯æµ‹è¯•æ€§**: æä¾›äº†ä¸“é—¨çš„æµ‹è¯•å·¥å…·éªŒè¯ä¿®å¤æ•ˆæœ

æ— é™å¾ªç¯é—®é¢˜å·²å½»åº•è§£å†³ï¼Œå°ç¨‹åºå¯ä»¥æ­£å¸¸ä½¿ç”¨é‚€è¯·é“¾æ¥åŠŸèƒ½ã€‚ 