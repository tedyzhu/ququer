# HOTFIX-v1.3.2 å‘é€æ–¹æ¶ˆæ¯æ¸…ç†å’Œé‡å¤ç³»ç»Ÿæ¶ˆæ¯ä¿®å¤

## é—®é¢˜æè¿°

æ ¹æ®ç”¨æˆ·åé¦ˆå’Œæ—¥å¿—åˆ†æžï¼Œå‘çŽ°äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

1. **å‘é€æ–¹æ¶ˆæ¯è¢«è¯¯æ¸…ç†**ï¼šå‘é€æ–¹å‘é€æ¶ˆæ¯åŽç«‹å³è¢«é˜…åŽå³ç„šé€»è¾‘æ¸…ç†ï¼Œå¯¼è‡´æ¶ˆæ¯æ¶ˆå¤±
2. **é‡å¤ç³»ç»Ÿæ¶ˆæ¯**ï¼šæ¯æ¬¡æœ‰æ¶ˆæ¯å˜åŒ–éƒ½ä¼šæ·»åŠ "å’Œxxå»ºç«‹äº†èŠå¤©"ç³»ç»Ÿæ¶ˆæ¯
3. **é˜…åŽå³ç„šè¿‡åº¦è§¦å‘**ï¼šæ¯æ¬¡èŽ·å–æ¶ˆæ¯éƒ½è§¦å‘æ¸…ç†æ£€æŸ¥ï¼ŒåŒ…æ‹¬æ­£å¸¸èŠå¤©æ¶ˆæ¯

## é—®é¢˜åˆ†æž

### æ—¥å¿—åˆ†æž
```
chat.js? [sm]:6351 ðŸ”¥ [é˜…åŽå³ç„š] âš ï¸ æ£€æµ‹åˆ°åŽ†å²èŠå¤©æ•°æ®ï¼Œä½œä¸ºé˜…åŽå³ç„šåº”ç”¨è‡ªåŠ¨æ¸…ç†
chat.js? [sm]:6356 ðŸ”¥ [é˜…åŽå³ç„š] åŽ†å²æ¶ˆæ¯è¯¦æƒ…: (20) [Object, Object, ...]
chat.js? [sm]:6237 ðŸ”¥ [å¼ºåˆ¶æ¸…ç†] ==================== å¼€å§‹å¼ºåˆ¶é˜…åŽå³ç„šæ¸…ç† ====================
chat.js? [sm]:2667 ðŸ“ æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯: {id: "sys_1751132555255_8d4l8", content: "å’Œå‘å†¬å»ºç«‹äº†èŠå¤©"}
```

**é—®é¢˜æ ¹æº**ï¼š
1. é˜…åŽå³ç„šé€»è¾‘å°†æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯éƒ½è§†ä¸º"åŽ†å²æ¶ˆæ¯"è¿›è¡Œæ¸…ç†
2. å‘é€æ–¹ç›‘å¬å™¨æ¯æ¬¡è§¦å‘éƒ½ä¼šæ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
3. ç¼ºä¹æ—¶é—´æˆ³åˆ¤æ–­å’Œé‡å¤æ£€æŸ¥æœºåˆ¶

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ™ºèƒ½é˜…åŽå³ç„šæ£€æŸ¥

#### ä¿®å¤ä½ç½®ï¼š`checkBurnAfterReadingCleanup()` æ–¹æ³•

**å…³é”®æ”¹è¿›**ï¼š
```javascript
// ðŸ”¥ ã€ä¿®å¤ã€‘é¿å…é‡å¤æ£€æŸ¥ï¼Œåªåœ¨é¡µé¢åˆå§‹åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡
if (this.data.hasCheckedBurnAfterReading) {
  console.log('ðŸ”¥ [é˜…åŽå³ç„šæ£€æŸ¥] å·²å®Œæˆåˆå§‹æ£€æŸ¥ï¼Œè·³è¿‡é‡å¤æ¸…ç†');
  return;
}

// ðŸ”¥ ã€ä¿®å¤ã€‘åªæœ‰åœ¨åŒæ–¹è¿žæŽ¥ä¸”æ£€æµ‹åˆ°åŽ†å²æ¶ˆæ¯æ—¶æ‰æ¸…ç†
const shouldCleanup = userMessages.length > 0 && 
                     participants.length >= 2 && 
                     !this.data.isNewChatSession;

// ðŸ”¥ æ£€æŸ¥æ¶ˆæ¯æ—¶é—´æˆ³ï¼Œå¦‚æžœéƒ½æ˜¯æœ€è¿‘å‘é€çš„ï¼Œå¯èƒ½æ˜¯æ­£å¸¸èŠå¤©
const recentMessages = userMessages.filter(msg => {
  const msgTime = msg.timestamp || 0;
  return (currentTime - msgTime) < 60000; // 1åˆ†é’Ÿå†…çš„æ¶ˆæ¯
});

if (recentMessages.length === userMessages.length) {
  console.log('ðŸ”¥ [é˜…åŽå³ç„šæ£€æŸ¥] æ£€æµ‹åˆ°çš„éƒ½æ˜¯æœ€è¿‘æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯æ­£å¸¸èŠå¤©ï¼Œè·³è¿‡æ¸…ç†');
  this.setData({ hasCheckedBurnAfterReading: true });
  return;
}
```

**ä¿®å¤æ•ˆæžœ**ï¼š
- åªåœ¨é¡µé¢åˆå§‹åŒ–æ—¶æ£€æŸ¥ä¸€æ¬¡
- åŒºåˆ†åŽ†å²æ¶ˆæ¯å’Œæ­£å¸¸èŠå¤©æ¶ˆæ¯
- é¿å…æ¸…ç†åˆšå‘é€çš„æ¶ˆæ¯

### 2. é˜²é‡å¤ç³»ç»Ÿæ¶ˆæ¯

#### ä¿®å¤ä½ç½®ï¼šå‘é€æ–¹ç›‘å¬å™¨ `startParticipantListener()` æ–¹æ³•

**å…³é”®æ”¹è¿›**ï¼š
```javascript
// ðŸ”¥ ã€ä¿®å¤ã€‘é¿å…é‡å¤æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
if (!this.data.hasAddedConnectionMessage) {
  const newJoiner = newParticipants.find(p => {
    return !currentParticipants.some(cp => (cp.openId || cp.id) === (p.openId || p.id));
  });
  
  if (newJoiner) {
    const joinerName = newJoiner.nickName || newJoiner.name || 'å¥½å‹';
    this.addSystemMessage(`å’Œ${joinerName}å»ºç«‹äº†èŠå¤©`);
    console.log('ðŸ”¥ [å‘é€æ–¹ç›‘å¬] âœ… å·²æ·»åŠ "å’Œå¥½å‹å»ºç«‹äº†èŠå¤©"ç³»ç»Ÿæ¶ˆæ¯');
    
    // ðŸ”¥ æ ‡è®°å·²æ·»åŠ ï¼Œé˜²æ­¢é‡å¤
    this.setData({ hasAddedConnectionMessage: true });
  }
} else {
  console.log('ðŸ”¥ [å‘é€æ–¹ç›‘å¬] é˜²é‡å¤ï¼šå·²æ·»åŠ è¿‡è¿žæŽ¥æ¶ˆæ¯ï¼Œè·³è¿‡');
}
```

**ä¿®å¤æ•ˆæžœ**ï¼š
- ä½¿ç”¨æ ‡è®°ä½é˜²æ­¢é‡å¤æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
- ç¡®ä¿"å’Œxxå»ºç«‹äº†èŠå¤©"æ¶ˆæ¯åªæ˜¾ç¤ºä¸€æ¬¡

### 3. é¡µé¢åˆå§‹åŒ–æ ‡è®°é‡ç½®

#### ä¿®å¤ä½ç½®ï¼š`onLoad()` æ–¹æ³•

**å…³é”®æ”¹è¿›**ï¼š
```javascript
// ðŸ”¥ ã€ä¿®å¤ã€‘é‡ç½®é˜…åŽå³ç„šå’Œç³»ç»Ÿæ¶ˆæ¯æ ‡è®°
this.setData({
  hasCheckedBurnAfterReading: false,
  hasAddedConnectionMessage: false,
  isNewChatSession: true
});
```

**ä¿®å¤æ•ˆæžœ**ï¼š
- æ¯æ¬¡è¿›å…¥é¡µé¢é‡ç½®æ‰€æœ‰æ ‡è®°
- ç¡®ä¿æ–°ä¼šè¯çš„æ­£ç¡®å¤„ç†

## ä¿®å¤å†…å®¹æ€»ç»“

### ðŸ”¥ é˜…åŽå³ç„šé€»è¾‘ä¼˜åŒ–

1. **æ—¶é—´æˆ³åˆ¤æ–­**ï¼šåŒºåˆ†åŽ†å²æ¶ˆæ¯å’Œæœ€è¿‘æ¶ˆæ¯
2. **ä¸€æ¬¡æ€§æ£€æŸ¥**ï¼šé¿å…é‡å¤æ¸…ç†æ­£å¸¸æ¶ˆæ¯
3. **æ¡ä»¶é™åˆ¶**ï¼šåªåœ¨åŒæ–¹è¿žæŽ¥ä¸”æœ‰çœŸæ­£åŽ†å²æ•°æ®æ—¶æ¸…ç†

### ðŸ·ï¸ ç³»ç»Ÿæ¶ˆæ¯åŽ»é‡

1. **æ ‡è®°æœºåˆ¶**ï¼šä½¿ç”¨`hasAddedConnectionMessage`é˜²é‡å¤
2. **æ¡ä»¶æ£€æŸ¥**ï¼šåªåœ¨é¦–æ¬¡æ£€æµ‹åˆ°å‚ä¸Žè€…åŠ å…¥æ—¶æ·»åŠ 
3. **çŠ¶æ€ç®¡ç†**ï¼šé¡µé¢åˆå§‹åŒ–æ—¶é‡ç½®æ ‡è®°

### ðŸ“‹ å…³é”®ä¿®å¤ç‚¹

1. **æ–‡ä»¶**ï¼š`app/pages/chat/chat.js`
2. **ä¿®å¤è¡Œæ•°**ï¼š
   - ç¬¬6333è¡Œï¼šæ™ºèƒ½é˜…åŽå³ç„šæ£€æŸ¥
   - ç¬¬1633è¡Œï¼šé˜²é‡å¤ç³»ç»Ÿæ¶ˆæ¯
   - ç¬¬405è¡Œï¼šé¡µé¢åˆå§‹åŒ–æ ‡è®°é‡ç½®

3. **æ–°å¢žæ ‡è®°å˜é‡**ï¼š
   - `hasCheckedBurnAfterReading`: æ˜¯å¦å·²æ£€æŸ¥é˜…åŽå³ç„š
   - `hasAddedConnectionMessage`: æ˜¯å¦å·²æ·»åŠ è¿žæŽ¥æ¶ˆæ¯
   - `isNewChatSession`: æ˜¯å¦ä¸ºæ–°èŠå¤©ä¼šè¯

## é¢„æœŸæ•ˆæžœ

### ðŸŽ¯ å‘é€æ–¹ä½“éªŒ

1. **æ­£å¸¸æ¶ˆæ¯å‘é€**ï¼šå‘é€çš„æ¶ˆæ¯ä¸ä¼šè¢«è¯¯æ¸…ç†
2. **ç³»ç»Ÿæç¤ºä¼˜åŒ–**ï¼šåªæ˜¾ç¤ºä¸€æ¬¡"å’Œxxå»ºç«‹äº†èŠå¤©"æ¶ˆæ¯
3. **æ ‡é¢˜æ˜¾ç¤ºæ­£ç¡®**ï¼šæ˜¾ç¤º"æˆ‘å’ŒY.ï¼ˆ2ï¼‰"æ ¼å¼

### ðŸŽ¯ æŽ¥æ”¶æ–¹ä½“éªŒ

1. **åŽ†å²æ¶ˆæ¯æ¸…ç†**ï¼šçœŸæ­£çš„åŽ†å²æ•°æ®ä¼šè¢«æ¸…ç†
2. **æ­£å¸¸æ¶ˆæ¯ä¿ç•™**ï¼šæœ€è¿‘çš„èŠå¤©æ¶ˆæ¯æ­£å¸¸æ˜¾ç¤º
3. **æ ‡é¢˜æ˜¾ç¤ºæ­£ç¡®**ï¼šæ˜¾ç¤ºå¯¹æ–¹çœŸå®žæ˜µç§°

### ðŸŽ¯ æ•´ä½“ä¼˜åŒ–

1. **æ€§èƒ½æå‡**ï¼šå‡å°‘ä¸å¿…è¦çš„æ¸…ç†æ“ä½œ
2. **ç”¨æˆ·ä½“éªŒ**ï¼šæ¶ˆé™¤é‡å¤æç¤ºå’Œé”™è¯¯æ¸…ç†
3. **é€»è¾‘æ¸…æ™°**ï¼šæ˜Žç¡®åŒºåˆ†åŽ†å²æ•°æ®å’Œæ­£å¸¸èŠå¤©

## æŠ€æœ¯ç»†èŠ‚

### æ¶ˆæ¯è¿‡æ»¤é€»è¾‘
```javascript
const userMessages = messages.filter(msg => 
  msg.senderId && 
  msg.senderId !== 'system' && 
  !msg.content.includes('æ‚¨åˆ›å»ºäº†ç§å¯†èŠå¤©') &&
  !msg.content.includes('æ¬¢è¿Žä½¿ç”¨é˜…åŽå³ç„šèŠå¤©') &&
  !msg.content.includes('å»ºç«‹äº†èŠå¤©')
);
```

### æ—¶é—´æˆ³æ£€æŸ¥é€»è¾‘
```javascript
const recentMessages = userMessages.filter(msg => {
  const msgTime = msg.timestamp || 0;
  return (currentTime - msgTime) < 60000; // 1åˆ†é’Ÿå†…çš„æ¶ˆæ¯
});
```

### é‡å¤æ£€æŸ¥æœºåˆ¶
```javascript
if (!this.data.hasAddedConnectionMessage) {
  // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
  this.setData({ hasAddedConnectionMessage: true });
}
```

## å…¼å®¹æ€§è¯´æ˜Ž

- ä¿æŒä¸ŽçŽ°æœ‰é˜…åŽå³ç„šåŠŸèƒ½çš„å…¼å®¹æ€§
- ä¸å½±å“çœŸæ­£çš„åŽ†å²æ•°æ®æ¸…ç†
- ç¡®ä¿æ–°ç”¨æˆ·å’Œè€ç”¨æˆ·çš„ä¸€è‡´ä½“éªŒ

## æµ‹è¯•å»ºè®®

1. **å‘é€æ–¹æµ‹è¯•**ï¼šåˆ›å»ºèŠå¤© â†’ ç­‰å¾…å¯¹æ–¹åŠ å…¥ â†’ å‘é€æ¶ˆæ¯ â†’ éªŒè¯æ¶ˆæ¯ä¸è¢«æ¸…ç†
2. **æŽ¥æ”¶æ–¹æµ‹è¯•**ï¼šé€šè¿‡é‚€è¯·åŠ å…¥ â†’ å‘é€æ¶ˆæ¯ â†’ éªŒè¯æ ‡é¢˜æ˜¾ç¤ºæ­£ç¡®
3. **åŽ†å²æ¸…ç†æµ‹è¯•**ï¼šé‡æ–°è¿›å…¥æœ‰åŽ†å²æ•°æ®çš„èŠå¤© â†’ éªŒè¯åŽ†å²æ•°æ®è¢«æ¸…ç† 