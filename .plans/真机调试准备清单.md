# 🚀 秘信小程序真机调试准备清单

## ✅ 已完成的清理工作

### 1. **删除测试页面**
- ❌ 删除 `app/pages/test-fix/` 目录及所有文件
- ❌ 删除 `app/pages/test-message/` 目录及所有文件
- ⚠️ 保留 `pages/test/test.js` 但从 `app.json` 中移除（可用于调试）

### 2. **清理测试代码**
- ❌ 删除 `pages/chat/chat.js` 中的 `simulateReply()` 函数
- ❌ 删除 `pages/home/home.js` 中的 `openTestPage()` 函数
- ❌ 删除 `pages/home/home.wxml` 中的测试按钮
- ❌ 删除 `pages/home/home.wxss` 中的测试按钮样式

### 3. **清理云函数测试代码**
- ❌ 删除 `cloudfunctions/checkChatStatus/index.js` 中的测试模式
- ❌ 删除 `cloudfunctions/createInvite/index.js` 中的测试模式
- ❌ 删除 `app.js` 中的云函数测试调用

### 4. **保留的文档**
- ✅ 保留 `.plans/` 目录下的所有修复总结文档
- ✅ 保留 `readme.md` 项目说明文档
- ✅ 保留 `云开发部署指南.md` 部署指南

## 📱 真机调试前检查清单

### 1. **云开发环境配置**
- [ ] 确认云环境ID配置正确：`ququer-env-6g35f0nv28c446e7`
- [ ] 检查所有云函数已正确部署
- [ ] 验证数据库集合权限设置

### 2. **必要的云函数列表**
- [ ] `login` - 用户登录
- [ ] `createInvite` - 创建邀请
- [ ] `joinByInvite` - 加入邀请
- [ ] `checkChatStatus` - 检查聊天状态
- [ ] `notifyJoined` - 通知已加入
- [ ] `startConversation` - 开始会话

### 3. **数据库集合检查**
- [ ] `users` - 用户信息集合
- [ ] `messages` - 消息集合
- [ ] `conversations` - 会话集合
- [ ] 所有集合权限设置为"所有用户可读写"（测试环境）

### 4. **小程序配置检查**
- [ ] `app.json` 页面路径配置正确
- [ ] 云开发权限已开通
- [ ] 小程序AppID配置正确

## 🔧 核心功能验证

### 1. **用户登录流程**
- [ ] 微信一键登录功能正常
- [ ] 用户信息正确保存到云数据库
- [ ] 登录状态持久化正常

### 2. **邀请链接功能**
- [ ] 创建邀请链接正常
- [ ] 分享邀请链接正常
- [ ] 被邀请者点击链接能正确进入聊天

### 3. **聊天功能**
- [ ] 消息发送正常
- [ ] 消息接收正常
- [ ] 实时监听器工作正常
- [ ] 无消息重复问题
- [ ] 无无限循环问题

### 4. **状态管理**
- [ ] 监听器状态管理正常
- [ ] 页面生命周期管理正常
- [ ] 内存泄漏已修复

## 🚨 已修复的关键问题

### 1. **无限循环问题** ✅
- **问题**：`loadMessages() → loadChatInfo() → handleChatStatus('active') → loadMessages()` 无限循环
- **修复**：添加状态检查和防重复调用机制

### 2. **消息重复问题** ✅
- **问题**：发送消息时本地添加 + 实时监听器添加导致重复
- **修复**：使用临时消息机制，依赖实时监听器统一管理

### 3. **监听器状态错误** ✅
- **问题**：`current state (CLOSED) does not accept "rebuildWatchFail"`
- **修复**：完善监听器状态管理和安全关闭机制

## 📋 真机测试计划

### 1. **基础功能测试**
1. 启动小程序，验证登录流程
2. 创建邀请链接，验证分享功能
3. 使用另一台设备接受邀请
4. 测试双向消息收发

### 2. **边界情况测试**
1. 网络断开重连测试
2. 小程序切换后台再回到前台
3. 多次快速发送消息
4. 长时间等待后发送消息

### 3. **性能测试**
1. 监听器内存使用情况
2. 页面切换流畅度
3. 消息加载速度

## 🎯 预期效果

### 1. **用户体验**
- ✅ 流畅的登录和邀请流程
- ✅ 实时的消息收发体验
- ✅ 稳定的聊天状态管理

### 2. **技术指标**
- ✅ 无控制台错误信息
- ✅ 无内存泄漏
- ✅ 监听器状态管理正常

### 3. **功能完整性**
- ✅ 邀请链接匹配正确
- ✅ 消息不重复不丢失
- ✅ 实时状态同步正常

## 📞 问题排查指南

### 1. **如果登录失败**
- 检查云环境ID配置
- 重新部署login云函数
- 查看云函数日志

### 2. **如果邀请链接无效**
- 检查createInvite云函数
- 验证数据库权限
- 查看控制台错误信息

### 3. **如果消息发送失败**
- 检查messages集合权限
- 验证实时监听器状态
- 查看网络连接状态

---

**准备完成！** 🎉 现在可以进行真机调试了。 