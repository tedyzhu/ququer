# 🚨 小程序无法唤起和发送失败修复指南

## 问题描述
- 小程序无法正常唤起
- 显示"发送失败，是否重新重试"的弹窗
- 聊天消息发送失败

## 🎯 解决方案（按优先级排序）

### 方案一：修复云环境配置（最重要）

#### 1. 重新部署云函数
```bash
# 确保在项目根目录执行
cd /Users/tedsmini/Desktop/app\ design/ququer/

# 重新部署关键云函数
./deploy-critical-functions.sh

# 如果上面的脚本不存在，手动部署：
# 在微信开发者工具中：
# 1. 打开"云开发"控制台
# 2. 选择环境：ququer-env-6g35f0nv28c446e7
# 3. 重新上传这些云函数：
#    - sendMessage
#    - getConversations
#    - login
#    - createChat
```

#### 2. 检查云环境状态
1. **在微信开发者工具中**：
   - 点击"云开发" → 选择 `ququer-env-6g35f0nv28c446e7`
   - 检查所有云函数是否正常运行
   - 查看云函数日志是否有错误

2. **验证云环境连接**：
   - 在小程序中打开调试控制台
   - 查看是否有 `-404006` 错误
   - 确认云环境初始化成功

### 方案二：重启小程序开发环境

#### 1. 完全重启
```bash
# 1. 完全关闭微信开发者工具
# 2. 清除缓存
./clear-all-cache.sh

# 3. 重新打开项目
# 4. 重新选择云环境
```

#### 2. 重新初始化云环境
1. 在微信开发者工具中删除当前云环境配置
2. 重新添加云环境：`ququer-env-6g35f0nv28c446e7`
3. 等待环境初始化完成

### 方案三：网络和权限检查

#### 1. 检查网络连接
- 确保网络稳定
- 检查防火墙设置
- 尝试切换网络环境

#### 2. 检查云开发权限
- 确认微信账号有该云环境的管理员权限
- 重新登录微信开发者工具

### 方案四：代码层面修复

#### 1. 增强错误处理（如果上述方法无效）
```javascript
// 在 app.js 的 initCloud 方法中添加更详细的错误处理
initCloud: function() {
  if (!wx.cloud) {
    console.error('请使用2.2.3或以上的基础库以使用云能力');
    wx.showModal({
      title: '版本过低',
      content: '请更新微信版本后重试',
      showCancel: false
    });
    return false;
  }

  try {
    wx.cloud.init({
      env: 'ququer-env-6g35f0nv28c446e7',
      traceUser: true,
      timeout: 15000, // 增加超时时间
      retry: 5        // 增加重试次数
    });
    
    this.globalData.cloudInitialized = true;
    console.log('✅ 云环境初始化成功');
    return true;
    
  } catch (e) {
    console.error('❌ 云环境初始化失败', e);
    
    wx.showModal({
      title: '初始化失败',
      content: '云环境连接失败，请检查网络后重试',
      confirmText: '重试',
      success: (res) => {
        if (res.confirm) {
          // 延迟重试
          setTimeout(() => this.initCloud(), 3000);
        }
      }
    });
    
    return false;
  }
}
```

#### 2. 优化消息发送错误处理
```javascript
// 在 chat.js 的 showMessageError 方法中添加重试选项
showMessageError: function(messageId) {
  const updatedMessages = this.data.messages.map(msg => {
    if (msg.id === messageId) {
      return { ...msg, status: 'failed' };
    }
    return msg;
  });

  this.setData({
    messages: updatedMessages
  });
  
  // 显示重试选项而不是简单的Toast
  wx.showModal({
    title: '发送失败',
    content: '消息发送失败，是否重新发送？',
    confirmText: '重试',
    cancelText: '取消',
    success: (res) => {
      if (res.confirm) {
        // 重新发送消息
        const failedMessage = this.data.messages.find(msg => msg.id === messageId);
        if (failedMessage) {
          this.sendMessage(failedMessage.content);
        }
      }
    }
  });
}
```

## 🔍 问题排查步骤

### 1. 检查云环境状态
```bash
# 在项目根目录执行
node -e "
const config = require('./cloudfunctions/config.json');
console.log('云环境ID:', config.env);
console.log('请在微信开发者工具中确认此环境是否正常');
"
```

### 2. 查看详细错误日志
1. 打开微信开发者工具调试器
2. 查看 Console 中的错误信息
3. 重点关注以下错误：
   - `-404006`：云环境未初始化
   - `network error`：网络连接问题
   - `timeout`：请求超时

### 3. 测试云函数连通性
在小程序中添加测试代码：
```javascript
// 测试云环境连接
wx.cloud.callFunction({
  name: 'login',
  data: { test: true },
  success: (res) => {
    console.log('✅ 云函数连接正常', res);
    wx.showToast({ title: '云函数正常', icon: 'success' });
  },
  fail: (err) => {
    console.error('❌ 云函数连接失败', err);
    wx.showModal({
      title: '连接失败',
      content: `错误：${err.errMsg}`,
      showCancel: false
    });
  }
});
```

## 🚨 应急处理方案

如果以上方案都无效，可以暂时使用以下应急方案：

### 1. 跳过云函数调用
```javascript
// 在发送消息失败时，使用本地存储临时保存
if (sendError) {
  // 保存到本地，待网络恢复后重新发送
  const pendingMessages = wx.getStorageSync('pendingMessages') || [];
  pendingMessages.push({
    id: messageId,
    content: message.content,
    timestamp: Date.now()
  });
  wx.setStorageSync('pendingMessages', pendingMessages);
  
  wx.showModal({
    title: '发送失败',
    content: '消息已保存，网络恢复后将自动重发',
    showCancel: false
  });
}
```

### 2. 使用备用云环境（如果有的话）
在 `cloudfunctions/config.json` 中配置备用环境。

## 📞 技术支持

如果问题仍然存在，请提供以下信息：
1. 微信开发者工具版本号
2. 云开发控制台截图
3. 完整的错误日志
4. 网络环境信息（公司网络/家庭网络/移动网络）

**优先建议**：先尝试方案一（重新部署云函数），这通常可以解决90%的相关问题。

## 🎯 预防措施

1. **定期检查云函数状态**
2. **设置云函数监控和告警**
3. **建立云环境备份机制**
4. **优化网络超时和重试配置**

---

*最后更新：2024年12月*
