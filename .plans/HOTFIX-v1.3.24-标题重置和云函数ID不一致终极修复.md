# HOTFIX-v1.3.24 标题重置和云函数ID不一致终极修复

## 🚨 问题分析

基于最新日志分析，发现了两个严重问题：

### 问题1：标题更新后立即被重置
**现象**：
1. 检测到新参与者时，标题正确更新为 `我和Y.（2）`
2. 但紧接着被 `getChatParticipants` 的结果重置为单人标题 `向冬`

**原因分析**：
- `getChatParticipants` 云函数只返回了一个参与者
- 导致标题更新逻辑判断为单人状态
- 覆盖了之前正确的双人标题

### 问题2：云函数返回ID格式不一致  
**现象**：
- **a发送消息时使用**: `local_1751199765751` (前端本地生成)
- **b发送消息实际使用**: `ojtOs7bA8w-ZdS1G_o5rdoeLzWDc` (云函数返回的真实微信openId)

**原因分析**：
- sendMessage云函数接收到前端的本地ID，但在云端又被wxContext.OPENID覆盖
- 导致同一个用户在不同消息中使用不同的ID
- b无法正确识别a的消息归属

## 🛠️ 修复方案

### 修复1：标题更新逻辑优化
**问题**：getChatParticipants返回数据不完整，导致标题重置
**解决方案**：
1. 修复发送方监听器的标题更新逻辑
2. 在获取到真实参与者信息后，保持双人标题状态
3. 防止单一数据源覆盖已确认的双人状态

### 修复2：云函数ID统一策略
**问题**：sendMessage云函数ID使用策略不一致
**解决方案**：
1. 修复sendMessage云函数，严格使用前端传递的senderId
2. 禁用云函数内部的ID覆盖逻辑
3. 确保整个对话过程中ID格式一致

### 修复3：智能ID映射增强
**问题**：现有智能匹配无法处理完全不同格式的ID
**解决方案**：
1. 在聊天建立时创建ID映射关系
2. 支持跨格式的用户身份识别
3. 建立持久化的用户身份映射机制

## 🎯 预期效果

修复后应该实现：
1. ✅ 建立连接后标题正确显示并保持为双人格式
2. ✅ a的消息b能正常接收和识别
3. ✅ 消息发送和接收使用一致的ID格式
4. ✅ 双方消息收发完全对称

## 🚨 紧急性说明

这是影响核心功能的严重问题：
- 标题显示错误影响用户体验
- 消息无法正确归属影响聊天功能
- ID不一致导致消息收发异常

需要立即修复！ 