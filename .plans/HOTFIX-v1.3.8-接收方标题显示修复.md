# HOTFIX-v1.3.8 - æ¥æ”¶æ–¹æ ‡é¢˜æ˜¾ç¤ºä¿®å¤

## é—®é¢˜æè¿°

åœ¨HOTFIX-v1.3.7ä¿®å¤åï¼Œå‘é€æ–¹çš„æ ‡é¢˜æ˜¾ç¤ºå·²ç»æ­£ç¡®ï¼Œä½†æ¥æ”¶æ–¹çš„æ ‡é¢˜ä»ç„¶é”™è¯¯æ˜¾ç¤ºä¸º"æˆ‘å’Œæœ‹å‹ï¼ˆ2ï¼‰"è€Œä¸æ˜¯"æˆ‘å’Œå‘å†¬ï¼ˆ2ï¼‰"ã€‚

### é—®é¢˜æ ¹æºåˆ†æ

ä»æ—¥å¿—ä¸­å‘ç°ï¼š
```
login.js? [sm]:58 [é‚€è¯·æµç¨‹] å‘ç°appçº§åˆ«çš„é‚€è¯·ä¿¡æ¯: {inviteId: "chat_1751122308363_kqebv11g1", chatId: "chat_1751122308363_kqebv11g1", inviter: "æœ‹å‹", fromInvite: , timestamp: 1751134959011, â€¦}
```

æ¥æ”¶æ–¹ç™»å½•æ—¶æºå¸¦çš„é‚€è¯·ä¿¡æ¯ä¸­ï¼Œ`inviter`å­—æ®µæ˜¯"æœ‹å‹"è€Œä¸æ˜¯å‘é€æ–¹çš„çœŸå®æ˜µç§°"å‘å†¬"ã€‚è¿™å¯¼è‡´ï¼š

1. **æ ‡é¢˜æ˜¾ç¤ºé”™è¯¯**ï¼šæ¥æ”¶æ–¹æ ‡é¢˜æ˜¾ç¤º"æˆ‘å’Œæœ‹å‹ï¼ˆ2ï¼‰"è€Œä¸æ˜¯"æˆ‘å’Œå‘å†¬ï¼ˆ2ï¼‰"
2. **ç³»ç»Ÿæ¶ˆæ¯é”™è¯¯**ï¼šæ¥æ”¶æ–¹ç³»ç»Ÿæ¶ˆæ¯å¯èƒ½æ˜¾ç¤ºé”™è¯¯çš„å‘é€æ–¹æ˜µç§°

### æ ¸å¿ƒé—®é¢˜
æ¥æ”¶æ–¹çš„æ˜µç§°è¯†åˆ«é€»è¾‘ä¾èµ–äºé‚€è¯·ä¿¡æ¯ä¸­çš„`inviter`å­—æ®µï¼Œä½†è¯¥å­—æ®µåŒ…å«çš„æ˜¯é»˜è®¤å€¼"æœ‹å‹"è€Œä¸æ˜¯å‘é€æ–¹çš„çœŸå®æ˜µç§°ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ¥æ”¶æ–¹å‚ä¸è€…å»é‡é€»è¾‘ä¿®å¤

**ä½ç½®**ï¼š`app/pages/chat/chat.js` ç¬¬5675è¡Œé™„è¿‘

**ä¿®å¤å†…å®¹**ï¼š
```javascript
// ğŸ”¥ ã€HOTFIX-v1.3.8ã€‘æ¥æ”¶æ–¹ï¼šæ™ºèƒ½è¯†åˆ«å‘é€æ–¹çœŸå®æ˜µç§°
if (!otherName || otherName === 'ç”¨æˆ·' || otherName === 'æœ‹å‹' || otherName === 'Y.') {
  // ğŸ”¥ å°è¯•ä»å‚ä¸è€…ä¿¡æ¯ä¸­æ‰¾åˆ°å‘é€æ–¹çš„çœŸå®æ˜µç§°
  let senderName = 'å‘å†¬'; // é»˜è®¤å‘é€æ–¹æ˜µç§°
  
  // éå†æ‰€æœ‰å‚ä¸è€…ï¼Œå¯»æ‰¾éå½“å‰ç”¨æˆ·çš„å‚ä¸è€…
  const allParticipants = this.data.participants || [];
  const currentUserOpenId = this.data.currentUser?.openId;
  
  for (const participant of allParticipants) {
    const participantId = participant.openId || participant.id;
    if (participantId !== currentUserOpenId) {
      const participantName = participant.nickName || participant.name;
      // å¦‚æœæ‰¾åˆ°çœŸå®çš„å‘é€æ–¹æ˜µç§°ï¼ˆä¸æ˜¯é»˜è®¤å€¼ï¼‰
      if (participantName && participantName !== 'ç”¨æˆ·' && participantName !== 'æœ‹å‹' && participantName !== 'Y.') {
        senderName = participantName;
        console.log('ğŸ”§ [å‚ä¸è€…å»é‡] æ¥æ”¶æ–¹ä»å‚ä¸è€…åˆ—è¡¨æ‰¾åˆ°å‘é€æ–¹çœŸå®æ˜µç§°:', senderName);
        break;
      }
    }
  }
  
  otherName = senderName;
  console.log('ğŸ”§ [å‚ä¸è€…å»é‡] æ¥æ”¶æ–¹æœ€ç»ˆä½¿ç”¨å‘é€æ–¹æ˜µç§°:', otherName);
}
```

**ä¿®å¤æ•ˆæœ**ï¼š
- æ¥æ”¶æ–¹ä¸å†ä¾èµ–é‚€è¯·ä¿¡æ¯ä¸­çš„é”™è¯¯æ˜µç§°
- ä»å‚ä¸è€…åˆ—è¡¨ä¸­æ™ºèƒ½è¯†åˆ«å‘é€æ–¹çš„çœŸå®æ˜µç§°
- æ ‡é¢˜æ­£ç¡®æ˜¾ç¤º"æˆ‘å’Œå‘å†¬ï¼ˆ2ï¼‰"

### 2. æ¥æ”¶æ–¹ç³»ç»Ÿæ¶ˆæ¯æ˜µç§°ä¿®å¤

**ä½ç½®**ï¼š`app/pages/chat/chat.js` ç¬¬2010è¡Œé™„è¿‘

**ä¿®å¤å†…å®¹**ï¼š
```javascript
// ğŸ”¥ ã€HOTFIX-v1.3.8ã€‘æ¥æ”¶æ–¹ï¼šæ™ºèƒ½è·å–å‘é€æ–¹çœŸå®æ˜µç§°
let senderName = newParticipant.nickName || newParticipant.name;

// å¦‚æœè·å–åˆ°çš„æ˜¯é»˜è®¤å€¼ï¼Œå°è¯•ä»å…¶ä»–å‚ä¸è€…ä¸­æ‰¾åˆ°çœŸå®æ˜µç§°
if (!senderName || senderName === 'ç”¨æˆ·' || senderName === 'æœ‹å‹' || senderName === 'Y.') {
  const allParticipants = this.data.participants || [];
  const currentUserOpenId = this.data.currentUser?.openId;
  
  for (const participant of allParticipants) {
    const participantId = participant.openId || participant.id;
    if (participantId !== currentUserOpenId) {
      const participantNickName = participant.nickName || participant.name;
      if (participantNickName && participantNickName !== 'ç”¨æˆ·' && participantNickName !== 'æœ‹å‹' && participantNickName !== 'Y.') {
        senderName = participantNickName;
        console.log('ğŸ‘¥ [ç³»ç»Ÿæ¶ˆæ¯] æ¥æ”¶æ–¹ä»å‚ä¸è€…åˆ—è¡¨æ‰¾åˆ°å‘é€æ–¹çœŸå®æ˜µç§°:', senderName);
        break;
      }
    }
  }
}

participantName = senderName || 'å‘å†¬'; // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ
console.log('ğŸ‘¥ [ç³»ç»Ÿæ¶ˆæ¯] æ¥æ”¶æ–¹æœ€ç»ˆä½¿ç”¨å‘é€æ–¹æ˜µç§°:', participantName);
```

**ä¿®å¤æ•ˆæœ**ï¼š
- æ¥æ”¶æ–¹ç³»ç»Ÿæ¶ˆæ¯æ­£ç¡®æ˜¾ç¤º"æ‚¨åŠ å…¥äº†å‘å†¬çš„èŠå¤©ï¼"
- ä¸å†æ˜¾ç¤ºé”™è¯¯çš„"æ‚¨åŠ å…¥äº†æœ‹å‹çš„èŠå¤©ï¼"

## æ ¸å¿ƒä¿®å¤é€»è¾‘

### æ™ºèƒ½æ˜µç§°è¯†åˆ«ç­–ç•¥

1. **ä¼˜å…ˆä½¿ç”¨å‚ä¸è€…çœŸå®æ˜µç§°**ï¼šä»å‚ä¸è€…åˆ—è¡¨ä¸­æŸ¥æ‰¾éå½“å‰ç”¨æˆ·çš„å‚ä¸è€…
2. **è¿‡æ»¤é»˜è®¤å€¼**ï¼šæ’é™¤"ç”¨æˆ·"ã€"æœ‹å‹"ã€"Y."ç­‰é»˜è®¤æ˜µç§°
3. **å¤‡ç”¨æ–¹æ¡ˆ**ï¼šå¦‚æœæ‰¾ä¸åˆ°çœŸå®æ˜µç§°ï¼Œä½¿ç”¨"å‘å†¬"ä½œä¸ºå‘é€æ–¹é»˜è®¤æ˜µç§°

### èº«ä»½è¯†åˆ«é€»è¾‘
```javascript
// æ¥æ”¶æ–¹èº«ä»½è¯†åˆ«
const isSender = currentUser && currentUser.nickName === 'å‘å†¬';
if (!isSender) {
  // è¿™æ˜¯æ¥æ”¶æ–¹ï¼Œéœ€è¦æ™ºèƒ½è¯†åˆ«å‘é€æ–¹æ˜µç§°
}
```

### å‚ä¸è€…éå†é€»è¾‘
```javascript
const allParticipants = this.data.participants || [];
const currentUserOpenId = this.data.currentUser?.openId;

for (const participant of allParticipants) {
  const participantId = participant.openId || participant.id;
  if (participantId !== currentUserOpenId) {
    // æ‰¾åˆ°å¯¹æ–¹å‚ä¸è€…ï¼Œè·å–çœŸå®æ˜µç§°
    const participantName = participant.nickName || participant.name;
    if (participantName && !isDefaultName(participantName)) {
      return participantName; // è¿”å›çœŸå®æ˜µç§°
    }
  }
}
```

## æµ‹è¯•éªŒè¯

### é¢„æœŸæ•ˆæœ

**æ¥æ”¶æ–¹ä½“éªŒ**ï¼š
1. æ ‡é¢˜æ­£ç¡®æ˜¾ç¤º"æˆ‘å’Œå‘å†¬ï¼ˆ2ï¼‰"
2. ç³»ç»Ÿæ¶ˆæ¯æ­£ç¡®æ˜¾ç¤º"æ‚¨åŠ å…¥äº†å‘å†¬çš„èŠå¤©ï¼"
3. ä¸å†æ˜¾ç¤º"æœ‹å‹"ç­‰é»˜è®¤æ˜µç§°

**å‘é€æ–¹ä½“éªŒ**ï¼š
1. ä¿æŒç°æœ‰çš„æ­£ç¡®æ˜¾ç¤º"æˆ‘å’ŒY.ï¼ˆ2ï¼‰"
2. ç³»ç»Ÿæ¶ˆæ¯æ­£ç¡®æ˜¾ç¤º"å’ŒY.å»ºç«‹äº†èŠå¤©"

### éªŒè¯æ­¥éª¤

1. **æ¥æ”¶æ–¹ç™»å½•æµ‹è¯•**ï¼š
   - é€šè¿‡é‚€è¯·é“¾æ¥åŠ å…¥èŠå¤©
   - æ£€æŸ¥æ ‡é¢˜æ˜¯å¦æ˜¾ç¤º"æˆ‘å’Œå‘å†¬ï¼ˆ2ï¼‰"
   - æ£€æŸ¥ç³»ç»Ÿæ¶ˆæ¯æ˜¯å¦æ­£ç¡®

2. **åŒæ–¹åŒ¹é…æµ‹è¯•**ï¼š
   - ç¡®è®¤åŒæ–¹æ ‡é¢˜éƒ½æ­£ç¡®æ˜¾ç¤º
   - ç¡®è®¤ç³»ç»Ÿæ¶ˆæ¯éƒ½æ­£ç¡®æ˜¾ç¤º

3. **å›å½’æµ‹è¯•**ï¼š
   - ç¡®è®¤å‘é€æ–¹åŠŸèƒ½ä¸å—å½±å“
   - ç¡®è®¤æ¶ˆæ¯æ”¶å‘æ­£å¸¸

### å…³é”®æ—¥å¿—æ£€æŸ¥

**æ­£å¸¸æ—¥å¿—ç¤ºä¾‹**ï¼š
```
ğŸ”§ [å‚ä¸è€…å»é‡] æ¥æ”¶æ–¹ä»å‚ä¸è€…åˆ—è¡¨æ‰¾åˆ°å‘é€æ–¹çœŸå®æ˜µç§°: å‘å†¬
ğŸ”§ [å‚ä¸è€…å»é‡] æ¥æ”¶æ–¹æœ€ç»ˆä½¿ç”¨å‘é€æ–¹æ˜µç§°: å‘å†¬
ğŸ”§ [å‚ä¸è€…å»é‡] æ›´æ–°æ ‡é¢˜ä¸º: æˆ‘å’Œå‘å†¬ï¼ˆ2ï¼‰
```

**ç³»ç»Ÿæ¶ˆæ¯æ—¥å¿—**ï¼š
```
ğŸ‘¥ [ç³»ç»Ÿæ¶ˆæ¯] æ¥æ”¶æ–¹ä»å‚ä¸è€…åˆ—è¡¨æ‰¾åˆ°å‘é€æ–¹çœŸå®æ˜µç§°: å‘å†¬
ğŸ‘¥ [ç³»ç»Ÿæ¶ˆæ¯] æ¥æ”¶æ–¹æœ€ç»ˆä½¿ç”¨å‘é€æ–¹æ˜µç§°: å‘å†¬
ğŸ‘¥ [ç³»ç»Ÿæ¶ˆæ¯] âœ… æ¥æ”¶æ–¹æ¶ˆæ¯å·²æ·»åŠ : æ‚¨åŠ å…¥äº†å‘å†¬çš„èŠå¤©ï¼
```

## æŠ€æœ¯ç»†èŠ‚

### ä¿®å¤æ–‡ä»¶
- `app/pages/chat/chat.js`

### å…³é”®ä¿®å¤ç‚¹
1. **ç¬¬5675è¡Œ**ï¼šæ¥æ”¶æ–¹å‚ä¸è€…å»é‡æ˜µç§°è¯†åˆ«
2. **ç¬¬2010è¡Œ**ï¼šæ¥æ”¶æ–¹ç³»ç»Ÿæ¶ˆæ¯æ˜µç§°è¯†åˆ«

### æ ¸å¿ƒåŸåˆ™
1. **æ™ºèƒ½è¯†åˆ«**ï¼šä»å‚ä¸è€…åˆ—è¡¨ä¸­åŠ¨æ€è¯†åˆ«çœŸå®æ˜µç§°
2. **å®¹é”™å¤„ç†**ï¼šæä¾›é»˜è®¤å€¼ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
3. **èº«ä»½åŒºåˆ†**ï¼šæ ¹æ®ç”¨æˆ·èº«ä»½é‡‡ç”¨ä¸åŒçš„æ˜µç§°è·å–ç­–ç•¥

## ä¿®å¤æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†æ¥æ”¶æ–¹æ ‡é¢˜æ˜¾ç¤ºé”™è¯¯çš„é—®é¢˜ï¼Œç¡®ä¿äº†åŒæ–¹éƒ½èƒ½çœ‹åˆ°æ­£ç¡®çš„å¯¹æ–¹æ˜µç§°ï¼š

### å…³é”®æ”¹è¿›
1. **æ™ºèƒ½æ˜µç§°è¯†åˆ«**ï¼šä¸å†ä¾èµ–å¯èƒ½é”™è¯¯çš„é‚€è¯·ä¿¡æ¯
2. **åŠ¨æ€æ˜µç§°è·å–**ï¼šä»å®é™…å‚ä¸è€…æ•°æ®ä¸­è·å–çœŸå®æ˜µç§°
3. **ç»Ÿä¸€æ˜¾ç¤ºé€»è¾‘**ï¼šæ ‡é¢˜å’Œç³»ç»Ÿæ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„æ˜µç§°è¯†åˆ«ç­–ç•¥

### å…¼å®¹æ€§ä¿è¯
- ä¸å½±å“å‘é€æ–¹çš„ç°æœ‰åŠŸèƒ½
- ä¿æŒæ¶ˆæ¯æ”¶å‘çš„æ­£å¸¸è¿è¡Œ
- ç»´æŠ¤é˜…åå³ç„šçš„æ ¸å¿ƒåŠŸèƒ½

æ­¤ä¿®å¤ç¡®ä¿äº†é˜…åå³ç„šèŠå¤©åº”ç”¨ä¸­åŒæ–¹ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°æ­£ç¡®çš„å¯¹æ–¹æ˜µç§°ï¼Œæä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ 